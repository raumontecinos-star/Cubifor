<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CubiFor - Cubicador Forestal</title>
    <meta name="theme-color" content="#1e2d3b"/>
    
    <!-- El Manifest ahora está "inline" usando un Data URI para mantener todo en un solo archivo -->
    <link rel="manifest" href='data:application/manifest+json;base64,ewogICJuYW1lIjogIkN1YmlGb3IgLSBDdWJpY2Fkb3IgRm9yZXN0YWwiLAogICJzaG9ydF9uYW1lIjogIkN1YmlGb3IiLAogICJzdGFydF91cmwiOiAiaW5kZXguaHRtbCIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiIzFlMjliYiIsCiAgInRoZW1lX2NvbG9yIjogIiMxZTJiYmYiLAogICJkZXNjcmlwdGlvbiIjogIlVuYSBhcGxpY2FjacOzbiBwYXJhIGN1YmljYWNpw7NuIGZvcmVzdGFsIGRlIFBpbm8geSBFdWNhbGlwdG8uIiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sLCUzQ3N2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAxOTIgMTkyJyBmaWxsPSclMjNhMmU2MzUnJTNFJTNDcmVjdCB3aWR0aD0nMTkyJyBoZWlnaHQ9JzE5Micgcng9JzMyJyBmaWxsPSclMjMxZTI5M2InLz4lM0VwYXRoIGQ9J005NiAxOGE2IDYgMCAwIDEgNiA2djkzLjVsMjYuNC0xMS4zOGE2IDYgMCAwIDEgNi40IDEyLjI0bC0zNiAxNS40NGE2IDYgMCAwIDEtNC44IDBsLTM2LTE1LjQ0YTYgNiAwIDAgMSA2LjQtMTIuMjRMODQgMTE2LjVWMjRhNiA2IDAgMCAxIDYtNlomJyAvJTNFJTNDcGF0aCBkPSdNMTU2IDEwOGE2IDYgMCAwIDEtNiA2SDQyYTYgNiAwIDEgMSAwLTEyaDEwOGE2IDYgMCAwIDEgNiA2Wi0gLz4lM0NwYXRoIGQ9J00xNTYgMTMyYTYgNiAwIDAgMS0xNiA2INDJhNiA2IDAgMSAxIDAtMTJoMTA4YTYgNiAwIDAgMSA2IDZaJyAvJTNFJTNDcGF0aCBkPSdNMTU2IDE1NmE2IDYgMCAwIDEtNiA2SDQyYTYgNiAwIDEgMSAwLTEyaDEwOGE2IDYgMCAwIDEgNiA2Wi0gLz4lM0Mvc3ZnJTNFJTIyLAogICAgICAic2l6ZXMiOiAiMTkyeDE5MiIsCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiCiAgICB9LAogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbCwlM0NzdmcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB2aWV3Qm94PScwIDAgNTEyIDUxMicgZmlsbD0nJTIzYTJlNjM1JyUzRSUzQ3JlY3Qgd2lkdGg9JzUxMicgaGVpZ2h0PSc1MTInIHJ4PSc4NScgZmlsbD0nJTIzMWUyOTNiJy8lM0VwYXRoIGQ9J00yNTYgNDhhMTYgMTYgMCAwIDEgMTYgMTZ2MjQ2LjY2bDcwLjQtMzAuMzRhMTYgMTYgMCAwIDEgMTcuMDYgMzIuNjRsLTk2IDQxLjE0YTE2IDE2IDAgMCAxLTEyLjggMGwtOTYtNDEuMTRhMTYgMTYgMCAwIDEgMTcuMDctMzIuNjRMMjQwIDMxMC42NlY2NGExNiAxNiAwIDAgMSAxNi0xNlomJyAvJTNFJTNDcGF0aCBkPSdNNDE2IDI4OGExNiAxNiAwIDAgMS0xNiAxNkgxMTJhMTYgMTYgMCAxIDEgMC0zMmgzODhhMTYgMTYgMCAwIDEgMTYgMTZaJyAvJTNFJTNDcGF0aCBkPSdNNDE2IDM1MGE2NiAxNiAwIDAgMS0xNiAxNkgxMTJhMTYgMTYgMCAxIDEgMC0zMmgzODhhMTYgMTYgMCAwIDEgMTYgMTZaJyAvJTNFJTNDcGF0aCBkPSdNNDE2IDQxNmExNiAxNiAwIDAgMS0xNiAxNkgxMTJhMTYgMTYgMCAxIDEgMC0zMmgzODhhMTYgMTYgMCAwIDEgMTYgMTZaJyAvJTNFJTNDL3N2ZyUzRSUyMiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIgogICAgfQogIF0KfQ=='>
    
    <!-- Icono para la pantalla de inicio y favicon -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23a3e635'%3E%3Cpath d='M12 2.25a.75.75 0 0 1 .75.75v11.563l3.3-1.423a.75.75 0 0 1 .8 1.53l-4.5 1.93a.75.75 0 0 1-.6-.001l-4.5-1.93a.75.75 0 0 1 .8-1.53l3.3 1.423V3a.75.75 0 0 1 .75-.75Z' /%3E%3Cpath d='M19.5 13.5a.75.75 0 0 1-.75.75H5.25a.75.75 0 0 1 0-1.5h13.5a.75.75 0 0 1 .75.75Z' /%3E%3Cpath d='M19.5 16.5a.75.75 0 0 1-.75.75H5.25a.75.75 0 0 1 0-1.5h13.5a.75.75 0 0 1 .75.75Z' /%3E%3Cpath d='M19.5 19.5a.75.75 0 0 1-.75.75H5.25a.75.75 0 0 1 0-1.5h13.5a.75.75 0 0 1 .75-.75Z' /%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23a3e635'%3E%3Crect width='24' height='24' rx='4' fill='%231e293b'/%3E%3Cpath d='M12 2.25a.75.75 0 0 1 .75.75v11.563l3.3-1.423a.75.75 0 0 1 .8 1.53l-4.5 1.93a.75.75 0 0 1-.6-.001l-4.5-1.93a.75.75 0 0 1 .8-1.53l3.3 1.423V3a.75.75 0 0 1 .75-.75Z' /%3E%3Cpath d='M19.5 13.5a.75.75 0 0 1-.75.75H5.25a.75.75 0 0 1 0-1.5h13.5a.75.75 0 0 1 .75.75Z' /%3E%3Cpath d='M19.5 16.5a.75.75 0 0 1-.75.75H5.25a.75.75 0 0 1 0-1.5h13.5a.75.75 0 0 1 .75.75Z' /%3E%3Cpath d='M19.5 19.5a.75.75 0 0 1-.75.75H5.25a.75.75 0 0 1 0-1.5h13.5a.75.75 0 0 1 .75-.75Z' /%3E%3C/svg%3E">
    <meta name="apple-mobile-web-app-title" content="CubiFor">
    <meta name="application-name" content="CubiFor">

    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Leaflet and Leaflet Draw CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />

    <style>
        /* --- START: CSS STYLES SECTION --- */

        /* --- SUB-SECTION: LAYOUT UTILITIES --- */
        .hidden { display: none !important; }
        .block { display: block; }
        .flex { display: flex; }
        .grid { display: grid; }
        .relative { position: relative; }
        .absolute { position: absolute; }
        .fixed { position: fixed; }
        .inset-0 { top: 0; right: 0; bottom: 0; left: 0; }
        /* --- END: SUB-SECTION: LAYOUT UTILITIES --- */
        
        /* --- SUB-SECTION: THEME VARIABLES (DARK MODE & HIGH CONTRAST) --- */
        :root {
            --bg-color: rgba(15, 23, 42, 0.8);
            --text-color: #e2e8f0;
            --border-color: rgba(255, 255, 255, 0.2);
            --input-bg: rgba(30, 41, 59, 0.5);
            --primary-color: #a3e635;
            --primary-text: #ffffff;
        }
        .high-contrast {
            --bg-color: rgba(255, 255, 255, 0.95);
            --text-color: #020617;
            --border-color: rgba(0, 0, 0, 0.3);
            --input-bg: rgba(226, 232, 240, 0.8);
            --primary-color: #166534;
            --primary-text: #ffffff;
        }
        /* --- END: SUB-SECTION: THEME VARIABLES --- */

        /* --- SUB-SECTION: GENERAL STYLES (BODY, CONTAINER) --- */
        body {
            font-family: 'Inter', sans-serif;
            background-image: url('https://images.unsplash.com/photo-1441974231531-c6227db76b6e?q=80&w=2560&auto-format&fit=crop');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        body.map-fullscreen-active, body.camera-active {
            overflow: hidden;
        }
        .main-container {
            background-color: var(--bg-color);
            color: var(--text-color);
            border-color: var(--border-color);
        }
        body.modal-open {
            overflow: hidden;
        }
        /* --- END: SUB-SECTION: GENERAL STYLES --- */
        
        /* --- SUB-SECTION: FORM & TAB STYLES --- */
        .input-field, select {
            background-color: var(--input-bg);
            border-color: var(--border-color);
            color: var(--text-color);
        }
        select {
             -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='currentColor' class='w-5 h-5'%3E%3Cpath fill-rule='evenodd' d='M5.22 8.22a.75.75 0 0 1 1.06 0L10 11.94l3.72-3.72a.75.75 0 1 1 1.06 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0L5.22 9.28a.75.75 0 0 1 0-1.06Z' clip-rule='evenodd' /%3E%3C/svg%3E%0A");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em 1.5em;
        }
        .tab-radio:checked + .tab-label {
            border-color: var(--primary-color);
            color: var(--primary-color);
            font-weight: 600;
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }
        /* --- END: SUB-SECTION: FORM & TAB STYLES --- */
        
        /* --- SUB-SECTION: SPECIFIC COMPONENT STYLES --- */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4d7c0f; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #65a30d; }
        
        #result {
            border-color: #64748b; /* slate-500 */
        }
        .high-contrast #result {
            border-color: var(--primary-color);
        }
        .result-table th, .result-table td { padding: 0.5rem 1rem; text-align: left; }
        .result-table th { opacity: 0.8; }
        .result-table td { font-weight: 600; }
        
        .modal {
            transition: opacity 0.25s ease;
        }
        
        #compass-rose {
            transition: transform 0.2s linear; /* Faster, linear transition for smoothness */
        }
        
        #map-container {
            position: relative;
            z-index: 0;
        }
        #map-container.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 5000;
        }

        .map-control-btn {
            position: absolute;
            z-index: 1000;
            background-color: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 0.5rem;
            border-radius: 9999px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .map-control-btn:hover {
            background-color: rgba(51, 65, 85, 0.9);
        }
        #map-expand-btn {
            top: 10px;
            right: 10px;
        }
        #map-close-btn {
            top: 10px;
            right: 10px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        .summary-grid .col-span-2 {
            grid-column: span 2 / span 2;
        }
        
        /* Leaflet Draw Customizations */
        .leaflet-draw-toolbar a {
            background-color: rgba(30, 41, 59, 0.8) !important;
            color: white !important;
            border-radius: 4px;
        }
         .leaflet-draw-toolbar a:hover {
            background-color: rgba(51, 65, 85, 0.9) !important;
        }
        .leaflet-draw-actions a {
            background-color: rgba(30, 41, 59, 0.8) !important;
            color: #a3e635 !important;
        }
        /* --- END: SUB-SECTION: SPECIFIC COMPONENT STYLES --- */

        /* --- END: CSS STYLES SECTION --- */
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- START: MAIN HTML STRUCTURE -->
    <div id="app-container" class="main-container w-full max-w-2xl mx-auto backdrop-blur-sm rounded-2xl shadow-2xl p-4 sm:p-6 border transition-colors duration-300 relative">
        
        <!-- START: App Header & Controls -->
        <div class="absolute top-4 right-4 flex items-center space-x-2">
             <button id="new-project-btn" class="p-2 rounded-full hover:bg-white/10 transition-colors" title="Nuevo Proyecto">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
             </button>
             <button id="load-project-btn" class="p-2 rounded-full hover:bg-white/10 transition-colors" title="Cargar Proyectos">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 10h16M4 14h16M4 18h16" /></svg>
            </button>
             <button id="save-project-btn" class="p-2 rounded-full hover:bg-white/10 transition-colors" title="Guardar Proyecto">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" /></svg>
            </button>
            <button id="theme-toggle" class="p-2 rounded-full hover:bg-white/10 transition-colors" title="Cambiar Tema">
                <svg id="theme-icon-sun" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                <svg id="theme-icon-moon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
            </button>
        </div>
        <!-- END: App Header & Controls -->

        <!-- START: Main Title -->
        <div class="text-center mb-8 pt-10">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-12 h-12 mx-auto text-lime-400 mb-2"><path d="M12 2.25a.75.75 0 0 1 .75.75v11.563l3.3-1.423a.75.75 0 0 1 .8 1.53l-4.5 1.93a.75.75 0 0 1-.6-.001l-4.5-1.93a.75.75 0 0 1 .8-1.53l3.3 1.423V3a.75.75 0 0 1 .75-.75Z" /><path d="M19.5 13.5a.75.75 0 0 1-.75.75H5.25a.75.75 0 0 1 0-1.5h13.5a.75.75 0 0 1 .75.75Z" /><path d="M19.5 16.5a.75.75 0 0 1-.75.75H5.25a.75.75 0 0 1 0-1.5h13.5a.75.75 0 0 1 .75.75Z" /><path d="M19.5 19.5a.75.75 0 0 1-.75.75H5.25a.75.75 0 0 1 0-1.5h13.5a.75.75 0 0 1 .75-.75Z" /></svg>
            <h1 class="text-3xl sm:text-4xl font-bold">CubiFor</h1>
            <p class="text-lg sm:text-xl mt-1 opacity-80">Cubicador Forestal</p>
            <p class="opacity-60 mt-2 text-sm">Pino y Eucalipto | Regiones de Ñuble y Biobío</p>
        </div>
        <!-- END: Main Title -->

        <!-- START: Tab Navigation -->
        <div class="flex justify-center border-b border-inherit mb-6">
            <div class="flex flex-wrap justify-center">
                <input type="radio" id="tab-ruma" name="tabs" class="hidden tab-radio" checked>
                <label for="tab-ruma" class="tab-label cursor-pointer px-3 py-2 sm:px-4 sm:py-3 text-sm sm:text-base border-b-2 border-transparent opacity-70 hover:opacity-100 transition-colors duration-300">Ruma</label>
                <input type="radio" id="tab-plot" name="tabs" class="hidden tab-radio">
                <label for="tab-plot" class="tab-label cursor-pointer px-3 py-2 sm:px-4 sm:py-3 text-sm sm:text-base border-b-2 border-transparent opacity-70 hover:opacity-100 transition-colors duration-300">Bosque</label>
                <input type="radio" id="tab-standing" name="tabs" class="hidden tab-radio">
                <label for="tab-standing" class="tab-label cursor-pointer px-3 py-2 sm:px-4 sm:py-3 text-sm sm:text-base border-b-2 border-transparent opacity-70 hover:opacity-100 transition-colors duration-300">Árbol</label>
                <input type="radio" id="tab-nav" name="tabs" class="hidden tab-radio">
                <label for="tab-nav" class="tab-label cursor-pointer px-3 py-2 sm:px-4 sm:py-3 text-sm sm:text-base border-b-2 border-transparent opacity-70 hover:opacity-100 transition-colors duration-300">Navegación</label>
            </div>
        </div>
        <!-- END: Tab Navigation -->

        <!-- START: Tab Content -->
        <div id="calculator-content">
            <!-- START: Tree Tab Content -->
            <div id="standingContent" class="hidden space-y-6">
                <p class="text-center opacity-70 text-sm">Calcula el volumen de un árbol individual.</p>
                <div><label for="species" class="block text-sm font-medium opacity-80 mb-2">Especie</label><select id="species" class="input-field w-full border rounded-md p-3 outline-none transition"><option value="pino">Pino Radiata</option><option value="globulus">Eucalipto Globulus</option></select></div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="dap" class="block text-sm font-medium opacity-80 mb-2">DAP (cm)</label>
                        <input type="number" min="0" id="dap" placeholder="Ej: 42.0" class="input-field w-full border rounded-md p-3 outline-none transition">
                    </div>
                    <div>
                        <label for="height" class="block text-sm font-medium opacity-80 mb-2">Altura Total (m)</label>
                        <input type="number" min="0" id="height" placeholder="Ej: 25.0" class="input-field w-full border rounded-md p-3 outline-none transition">
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <button id="measure-tree-btn" class="flex-grow w-full bg-indigo-800/80 hover:bg-indigo-800 font-semibold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center space-x-2 border border-indigo-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                        <span>Medir con Cámara</span>
                    </button>
                    <button id="measurement-help-btn" class="flex-shrink-0 p-3 rounded-full bg-slate-700/50 hover:bg-slate-700/80 transition-colors" title="Guía de Medición">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </button>
                </div>
                <div><label for="standingVolumeType" class="block text-sm font-medium opacity-80 mb-2">Tipo de Volumen</label><select id="standingVolumeType" class="input-field w-full border rounded-md p-3 outline-none transition"><option value="total">Volumen Total (Vcc)</option><option value="commercial">Volumen Comercial (Estimado)</option></select></div>
                <div><label for="standingMethod" class="block text-sm font-medium opacity-80 mb-2">Método de Cálculo</label><select id="standingMethod" class="input-field w-full border rounded-md p-3 outline-none transition"><option value="equation">Ecuación de Volumen (Recomendado)</option><option value="form_factor">Factor de Forma</option></select></div>
            </div>
            <!-- END: Tree Tab Content -->
            
            <!-- START: Forest Tab Content -->
            <div id="plotContent" class="hidden space-y-6">
                <div id="plot-project-summary" class="hidden bg-black/20 p-4 rounded-lg text-center">
                    <h3 id="plot-project-title" class="text-lg font-semibold text-lime-300"></h3>
                    <p class="text-sm opacity-80 mt-1">Total Acumulado del Proyecto</p>
                    <div id="plot-total-volume" class="text-xl font-bold"></div>
                    <button id="view-plot-details-btn" class="mt-2 text-lime-400 text-sm font-semibold hover:underline">Ver/Editar Parcelas</button>
                </div>
                <p class="text-center opacity-70 text-sm">Estima el volumen total de un bosque a partir de parcelas de muestreo.</p>
                <div class="bg-black/20 p-4 rounded-lg">
                    <label for="totalAreaHa" class="block text-sm font-medium opacity-80 mb-2">Superficie Total del Predio (hectáreas)</label>
                    <input type="number" min="0" id="totalAreaHa" placeholder="Ej: 15.5" class="input-field w-full border rounded-md p-3 outline-none transition">
                </div>
                <div id="plotList" class="space-y-4 max-h-96 overflow-y-auto custom-scrollbar pr-2"></div>
                <button id="addPlotBtn" class="w-full bg-lime-900/50 hover:bg-lime-900/80 font-semibold py-2 px-4 rounded-lg transition duration-300 flex items-center justify-center space-x-2 border border-lime-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110 2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg><span>Agregar Parcela de Muestreo</span></button>
            </div>
            <!-- END: Forest Tab Content -->

            <!-- START: Stack Tab Content -->
            <div id="rumaContent" class="space-y-6">
                 <div id="ruma-project-summary" class="hidden bg-black/20 p-4 rounded-lg">
                    <h3 id="ruma-project-title" class="text-lg font-semibold text-lime-300 text-center mb-4"></h3>
                    <div id="ruma-total-volume" class="summary-grid text-center">
                        <!-- Summary data will be injected here by JS -->
                    </div>
                    <button id="view-ruma-history-btn" class="mt-4 w-full text-lime-400 text-sm font-semibold hover:underline text-center">Ver Historial de Movimientos</button>
                </div>
                <div id="ruma-calculator-container" class="space-y-4">
                    <div><label for="ruma_species" class="block text-sm font-medium opacity-80 mb-2">Especie</label><select id="ruma_species" class="input-field w-full border rounded-md p-3 outline-none transition"><option value="eucalipto">Eucalipto (por Pila)</option><option value="pino">Pino (por Trozo)</option></select></div>
                    
                    <!-- Movement Selector -->
                    <div>
                        <label for="ruma_movement_type" class="block text-sm font-medium opacity-80 mb-2">Tipo de Movimiento</label>
                        <select id="ruma_movement_type" class="input-field w-full border rounded-md p-3 outline-none transition">
                            <option value="entry">Entrada de Producción</option>
                            <option value="sale">Salida por Venta</option>
                        </select>
                    </div>

                    <!-- Container for ENTRIES -->
                    <div id="ruma-entry-container">
                        <div id="ruma_euca_inputs" class="space-y-6">
                            <p class="text-center opacity-70 text-sm">Calcula el volumen de una pila de madera (metro ruma).</p>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div><label for="ruma_largo" class="block text-sm font-medium opacity-80 mb-2">Largo Pila (m)</label><input type="number" min="0" id="ruma_largo" placeholder="Ej: 10.0" class="input-field w-full border rounded-md p-3 outline-none transition"></div>
                                <div>
                                    <label for="ruma_trozo_select" class="block text-sm font-medium opacity-80 mb-2">Largo Trozo</label>
                                    <select id="ruma_trozo_select" class="input-field w-full border rounded-md p-3 outline-none transition">
                                        <option value="2.44">2.44 m (Pulpable)</option>
                                        <option value="3.50">3.50 m (Pulpable)</option>
                                        <option value="3.20">3.20 m (Aserrable)</option>
                                        <option value="4.00">4.00 m (Vigas)</option>
                                        <option value="5.20">5.20 m (Postes / Exportación)</option>
                                        <option value="other">Otro</option>
                                    </select>
                                    <input type="number" min="0" id="ruma_trozo_other" placeholder="Largo (m)" class="hidden input-field w-full border rounded-md p-3 outline-none transition mt-2">
                                </div>
                            </div>
                            <div><label class="block text-sm font-medium opacity-80 mb-2">Alturas de la Pila (m)</label><div id="ruma_heights_container" class="space-y-2 max-h-48 overflow-y-auto custom-scrollbar pr-2"></div><button id="addRumaHeightBtn" class="mt-3 w-full bg-white/5 hover:bg-white/10 font-semibold py-2 px-4 rounded-lg transition duration-300 flex items-center justify-center space-x-2 text-sm border border-inherit"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110 2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg><span>Agregar Medición de Altura</span></button></div>
                        </div>
                        <div id="ruma_pino_inputs" class="hidden space-y-6">
                            <p class="text-center opacity-70 text-sm">Calcula el volumen sólido sumando cada trozo.</p>
                            <div class="space-y-4">
                                <div>
                                    <div class="flex items-center space-x-2 mb-2">
                                        <label for="ruma_pino_method" class="block text-sm font-medium opacity-80">Método por Trozo</label>
                                        <button id="ruma-help-btn" class="p-1 rounded-full hover:bg-white/20 transition-colors" title="Ayuda sobre métodos de medición">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                        </button>
                                    </div>
                                    <select id="ruma_pino_method" class="input-field w-full border rounded-md p-3 outline-none transition">
                                        <option value="smalian">Smalian</option>
                                        <option value="huber">Huber</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="ruma_pino_trozo_select" class="block text-sm font-medium opacity-80 mb-2">Largo de Trozos</label>
                                    <select id="ruma_pino_trozo_select" class="input-field w-full border rounded-md p-3 outline-none transition">
                                        <option value="2.44">2.44 m (Pulpable)</option>
                                        <option value="3.50">3.50 m (Pulpable)</option>
                                        <option value="3.20">3.20 m (Aserrable)</option>
                                        <option value="4.00">4.00 m (Vigas)</option>
                                        <option value="5.20">5.20 m (Postes / Exportación)</option>
                                        <option value="other">Otro</option>
                                    </select>
                                    <input type="number" min="0" id="ruma_pino_trozo_other" placeholder="Largo (m)" class="hidden input-field w-full border rounded-md p-3 outline-none transition mt-2">
                                </div>
                            </div>
                            <div id="ruma_pino_logs_container" class="space-y-4 max-h-96 overflow-y-auto custom-scrollbar pr-2"></div>
                            <button id="addRumaLogBtn" class="w-full bg-lime-900/50 hover:bg-lime-900/80 font-semibold py-2 px-4 rounded-lg transition duration-300 flex items-center justify-center space-x-2 border border-lime-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110 2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg><span>Agregar Trozo</span></button>
                        </div>
                    </div>
                    
                    <!-- Container for SALES -->
                    <div id="ruma-sale-container" class="hidden space-y-4">
                         <p class="text-center opacity-70 text-sm">Registra una venta o salida de material.</p>
                        <div>
                            <label for="ruma_sale_volume" class="block text-sm font-medium opacity-80 mb-2">Volumen de Salida (<span id="ruma_sale_unit"></span>)</label>
                            <input type="number" min="0" id="ruma_sale_volume" placeholder="Ej: 50.0" class="input-field w-full border rounded-md p-3 outline-none transition">
                        </div>
                        <div>
                            <label for="ruma_sale_unit_price" class="block text-sm font-medium opacity-80 mb-2">Precio Unitario de Venta (CLP / <span id="ruma_sale_unit_label"></span>)</label>
                            <input type="number" min="0" id="ruma_sale_unit_price" placeholder="Ej: 25000" class="input-field w-full border rounded-md p-3 outline-none transition">
                        </div>
                        <div class="mt-2 text-center bg-black/20 p-3 rounded-lg">
                            <p class="text-sm opacity-70">Ingreso Total Calculado</p>
                            <p id="ruma_sale_total_income" class="font-bold text-xl text-lime-300">$0</p>
                        </div>
                        <div>
                            <label for="ruma_sale_client" class="block text-sm font-medium opacity-80 mb-2">Cliente / Destino (Opcional)</label>
                            <input type="text" id="ruma_sale_client" placeholder="Ej: Aserradero Maderas del Sur" class="input-field w-full border rounded-md p-3 outline-none transition">
                        </div>
                    </div>

                </div>
            </div>
            <!-- END: Stack Tab Content -->

            <!-- START: Navigation Tab Content -->
            <div id="navContent" class="hidden space-y-4">
                <div id="activate-sensors-container">
                    <button id="activate-sensors-btn" class="w-full bg-sky-800/80 hover:bg-sky-800 font-semibold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center space-x-2 border border-sky-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                        <span>Activar Sensores y Mapa</span>
                    </button>
                    <p id="sensors-error" class="text-center text-red-400 mt-4 text-sm"></p>
                </div>
                <div id="sensors-content" class="hidden space-y-4">
                    <!-- Map Container -->
                    <div id="map-container" class="h-64 sm:h-80 w-full rounded-lg border border-inherit">
                        <div id="map" class="w-full h-full"></div>
                        <button id="map-expand-btn" class="map-control-btn" title="Pantalla Completa">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 0h-4m4 0l-5-5" /></svg>
                        </button>
                        <button id="map-close-btn" class="map-control-btn hidden" title="Cerrar Pantalla Completa">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    </div>

                    <!-- Drawing and ROL Tools -->
                    <div id="drawing-tools-container" class="bg-black/20 p-4 rounded-lg space-y-4 hidden">
                        <div>
                            <p class="text-sm font-semibold opacity-80 mb-2">Delimitación de Predios</p>
                            <div class="flex flex-col sm:flex-row gap-2">
                                <button id="start-draw-btn" class="flex-1 bg-blue-800/70 hover:bg-blue-800 text-sm font-semibold py-2 px-3 rounded-lg transition duration-300 flex items-center justify-center space-x-2 border border-blue-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>
                                    <span>Dibujo Manual</span>
                                </button>
                                <button id="undo-draw-btn" class="flex-1 bg-yellow-600/70 hover:bg-yellow-600 text-sm font-semibold py-2 px-3 rounded-lg transition duration-300 flex items-center justify-center space-x-2 border border-yellow-500 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.707 14.707a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 1.414L7.414 9H16a1 1 0 110 2H7.414l2.293 2.293a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                                    <span>Deshacer</span>
                                </button>
                            </div>
                            <div class="mt-3">
                                <label class="block text-xs font-medium opacity-80 mb-1">Buscar por ROL</label>
                                <div class="flex gap-2">
                                    <input type="text" id="rol-input" placeholder="Ej: 1234-56" class="input-field w-full border rounded-md p-2 outline-none transition text-sm">
                                    <button id="search-rol-btn" class="bg-green-800/70 hover:bg-green-800 font-semibold py-2 px-3 rounded-lg transition duration-300 border border-green-600">Buscar</button>
                                </div>
                            </div>
                        </div>
                        <div id="drawing-results-container" class="hidden text-center bg-black/30 p-3 rounded-lg">
                            <p class="text-sm opacity-80">Resultados del Polígono</p>
                            <div class="grid grid-cols-2 gap-2 mt-2">
                                <div>
                                    <p id="calculated-area" class="font-bold text-lg text-lime-300">-- ha</p>
                                    <p class="text-xs opacity-60">Área</p>
                                </div>
                                <div>
                                    <p id="calculated-perimeter" class="font-bold text-lg text-lime-300">-- m</p>
                                    <p class="text-xs opacity-60">Perímetro</p>
                                </div>
                            </div>
                            <button id="use-area-btn" class="mt-3 w-full bg-lime-600 hover:bg-lime-700 text-sm font-semibold py-2 px-3 rounded-lg transition duration-300">Usar esta Área en "Bosque"</button>
                             <button id="export-map-pdf-btn" class="mt-2 w-full bg-red-800/70 hover:bg-red-800 text-sm font-semibold py-2 px-3 rounded-lg transition duration-300 border border-red-600">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v3.586l-1.293-1.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V8z" clip-rule="evenodd" /></svg>
                                Exportar Informe PDF
                            </button>
                        </div>
                    </div>

                    <!-- Sensors Grid -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <!-- Compass Section -->
                        <div class="bg-black/20 p-4 rounded-lg text-center">
                            <h3 class="font-semibold text-lg mb-2">Brújula</h3>
                            <div class="relative w-40 h-40 sm:w-48 sm:h-48 mx-auto">
                                <div class="w-full h-full bg-slate-700 rounded-full flex items-center justify-center">
                                    <svg id="compass-rose" class="w-full h-full p-2" viewBox="0 0 100 100">
                                        <!-- Círculos y marcas -->
                                        <circle cx="50" cy="50" r="48" stroke="rgba(255,255,255,0.3)" stroke-width="1" fill="none"/>
                                        <circle cx="50" cy="50" r="40" stroke="rgba(255,255,255,0.1)" stroke-width="1" fill="none"/>
                                        <path d="M50 0 L45 10 L50 2 L55 10 Z" fill="#ef4444"/> <!-- Flecha Norte -->
                                        <!-- Marcas cardinales e intercardinales -->
                                        <line x1="50" y1="2" x2="50" y2="10" stroke="rgba(255,255,255,0.7)" stroke-width="1.5"/>
                                        <line x1="50" y1="98" x2="50" y2="90" stroke="rgba(255,255,255,0.7)" stroke-width="1.5"/>
                                        <line x1="2" y1="50" x2="10" y2="50" stroke="rgba(255,255,255,0.7)" stroke-width="1.5"/>
                                        <line x1="98" y1="50" x2="90" y2="50" stroke="rgba(255,255,255,0.7)" stroke-width="1.5"/>
                                        <line x1="29.29" y1="29.29" x2="35.35" y2="35.35" stroke="rgba(255,255,255,0.4)" stroke-width="1"/>
                                        <line x1="70.71" y1="29.29" x2="64.65" y2="35.35" stroke="rgba(255,255,255,0.4)" stroke-width="1"/>
                                        <line x1="29.29" y1="70.71" x2="35.35" y2="64.65" stroke="rgba(255,255,255,0.4)" stroke-width="1"/>
                                        <line x1="70.71" y1="70.71" x2="64.65" y2="64.65" stroke="rgba(255,255,255,0.4)" stroke-width="1"/>
                                        <!-- Letras -->
                                        <text x="50" y="22" font-size="12" fill="#ef4444" font-weight="bold" text-anchor="middle">N</text>
                                        <text x="50" y="88" font-size="12" fill="rgba(255,255,255,0.9)" font-weight="bold" text-anchor="middle">S</text>
                                        <text x="16" y="55" font-size="12" fill="rgba(255,255,255,0.9)" font-weight="bold" text-anchor="middle">O</text>
                                        <text x="84" y="55" font-size="12" fill="rgba(255,255,255,0.9)" font-weight="bold" text-anchor="middle">E</text>
                                    </svg>
                                </div>
                            </div>
                            <p id="azimuth" class="text-2xl font-bold font-mono mt-2">--°</p>
                            <p id="direction" class="opacity-80">--</p>
                        </div>
                        <!-- GPS Section -->
                        <div class="bg-black/20 p-4 rounded-lg flex flex-col justify-center">
                            <h3 class="font-semibold text-lg mb-2 text-center">Coordenadas GPS</h3>
                            <div class="space-y-2 text-center">
                                <div>
                                    <p class="text-sm opacity-70">Latitud</p>
                                    <p id="latitude" class="font-mono font-semibold">--</p>
                                </div>
                                <div>
                                    <p class="text-sm opacity-70">Longitud</p>
                                    <p id="longitude" class="font-mono font-semibold">--</p>
                                </div>
                                <div>
                                    <p class="text-sm opacity-70">Precisión</p>
                                    <p id="accuracy" class="font-mono font-semibold">--</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- END: Navigation Tab Content -->
        </div>
        <!-- END: Tab Content -->

        <!-- START: Results & Value Calculator Container -->
        <div id="result-container" class="hidden mt-8">
            <div id="result" class="bg-black/20 p-4 sm:p-6 rounded-lg border shadow-inner">
                <p id="result-title" class="text-center opacity-80 text-lg mb-2">Volumen Estimado</p>
                <div id="result-value" class="text-2xl sm:text-3xl font-bold text-white text-center"></div>
                <button id="add-ruma-to-project-btn" class="hidden w-full mt-4 bg-lime-600 hover:bg-lime-700 font-semibold py-2 px-4 rounded-lg transition duration-300 flex items-center justify-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" /></svg>
                    <span id="add-ruma-btn-text">Añadir al Registro</span>
                </button>
            </div>
            <div id="value-calculator" class="mt-6 bg-black/20 p-4 sm:p-6 rounded-lg border border-white/20">
                <h3 class="text-lg font-semibold mb-4 text-center">Calculadora de Valor</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-end">
                    <div>
                        <label for="price-species" class="block text-sm font-medium opacity-80 mb-2">Especie y Unidad</label>
                        <select id="price-species" class="input-field w-full border rounded-md p-3 outline-none transition">
                            <option value="pino">Pino (CLP / m³)</option>
                            <option value="eucalipto">Eucalipto (CLP / metro ruma)</option>
                        </select>
                    </div>
                    <div>
                        <label for="price" class="block text-sm font-medium opacity-80 mb-2">Precio</label>
                        <input type="number" min="0" id="price" placeholder="Ej: 25000" class="input-field w-full border rounded-md p-3 outline-none transition">
                    </div>
                </div>
                <div id="value-result-container" class="hidden mt-4 text-center">
                    <p class="opacity-80">Valor Monetario Total Estimado</p>
                    <p id="value-result" class="text-2xl sm:text-3xl font-bold text-white"></p>
                </div>
            </div>
            <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
                 <button id="export-csv-btn" class="w-full bg-green-800/80 hover:bg-green-800 font-semibold py-2 px-4 rounded-lg transition duration-300 flex items-center justify-center space-x-2 border border-green-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                    <span>Exportar a CSV</span>
                </button>
                <button id="export-pdf-btn" class="w-full bg-blue-900/50 hover:bg-blue-900/80 font-semibold py-2 px-4 rounded-lg transition duration-300 flex items-center justify-center space-x-2 border border-blue-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v3.586l-1.293-1.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V8z" clip-rule="evenodd" /></svg>
                    <span>Exportar a PDF</span>
                </button>
            </div>
        </div>
        <!-- END: Results & Value Calculator Container -->
        
        <!-- START: Footer -->
        <div class="text-center mt-8">
            <p class="text-xs opacity-60">Nota: El volumen comercial (82%) y el factor de ruma (0.65) son estimaciones basadas en estándares de INFOR y la industria forestal chilena.</p>
        </div>
        <!-- END: Footer -->
    </div>
    
    <!-- START: Modals (pop-up windows) -->
    <div id="restore-session-modal" class="modal hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="bg-slate-800 rounded-lg p-6 shadow-xl max-w-sm w-full text-center">
            <h3 class="text-lg font-bold text-white mb-2">Sesión Anterior Encontrada</h3>
            <p class="text-slate-300 mb-6">¿Deseas restaurar los datos que ingresaste previamente?</p>
            <div class="flex justify-center space-x-4">
                <button id="restore-yes" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition">Sí, restaurar</button>
                <button id="restore-no" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition">No, empezar de nuevo</button>
            </div>
        </div>
    </div>

    <div id="save-project-modal" class="modal hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="bg-slate-800 rounded-lg p-6 shadow-xl max-w-sm w-full text-center">
            <h3 class="text-lg font-bold text-white mb-4">Guardar Proyecto</h3>
            <input type="text" id="project-name-input" placeholder="Nombre del proyecto (Ej: Predio Santa Ana)" class="input-field w-full border rounded-md p-3 outline-none transition mb-4">
            <div class="flex justify-center space-x-4">
                <button id="save-project-confirm" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition">Guardar</button>
                <button id="save-project-cancel" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg transition">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="load-project-modal" class="modal hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="bg-slate-800 rounded-lg p-6 shadow-xl max-w-md w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-white">Cargar Proyecto</h3>
                <button id="load-project-close" class="p-1 rounded-full hover:bg-white/10">&times;</button>
            </div>
            <div id="project-list" class="max-h-80 overflow-y-auto custom-scrollbar space-y-2"></div>
        </div>
    </div>

    <div id="ruma-history-modal" class="modal hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="bg-slate-800 rounded-lg p-6 shadow-xl max-w-md w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-white">Historial de Movimientos</h3>
                <button id="ruma-history-close" class="p-1 rounded-full hover:bg-white/10 text-2xl leading-none">&times;</button>
            </div>
            <div id="ruma-history-list" class="max-h-80 overflow-y-auto custom-scrollbar space-y-2"></div>
        </div>
    </div>

    <div id="camera-measurement-modal" class="modal hidden fixed inset-0 bg-black flex flex-col items-center justify-center z-[9999] opacity-0 pointer-events-none">
        <video id="camera-feed" class="absolute top-0 left-0 w-full h-full object-cover z-0" autoplay playsinline></video>
        <div id="camera-overlay" class="relative z-10 w-full h-full flex flex-col p-4 text-white">
            <!-- Top Instructions -->
            <div class="text-center bg-black/50 p-3 rounded-lg backdrop-blur-sm">
                <p id="camera-step-title" class="text-lg font-bold"></p>
                <p id="camera-instructions" class="text-sm opacity-90"></p>
            </div>

            <!-- Live Angle Display -->
            <div id="live-angle-container" class="absolute bottom-28 left-4 text-center bg-black/50 p-2 rounded-lg backdrop-blur-sm text-sm">
                <p id="live-angle-display" class="font-mono text-lg">--.--°</p>
                <p class="text-xs opacity-80">Inclinación</p>
            </div>
    
            <!-- Center Aiming Reticle -->
            <div class="flex-grow flex items-center justify-center relative">
                <svg id="camera-reticle" class="w-16 h-16 text-lime-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="filter: drop-shadow(0 0 3px rgba(0,0,0,0.7));">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 12h18M12 3v18" />
                    <circle cx="12" cy="12" r="4" stroke-opacity="0.5"/>
                </svg>
                <!-- DAP Measurement Lines -->
                <div id="dap-lines-container" class="hidden absolute inset-0 flex justify-center items-center pointer-events-none">
                    <div id="dap-line-left" class="h-1/2 w-1 bg-red-500 cursor-col-resize pointer-events-auto rounded-full" style="box-shadow: 0 0 5px white; position: absolute; transform: translateX(-50px);"></div>
                    <div id="dap-line-right" class="h-1/2 w-1 bg-red-500 cursor-col-resize pointer-events-auto rounded-full" style="box-shadow: 0 0 5px white; position: absolute; transform: translateX(50px);"></div>
                </div>
            </div>
    
            <!-- Bottom Controls -->
            <div id="camera-controls" class="text-center bg-black/50 p-3 rounded-lg backdrop-blur-sm space-y-3">
                 <div id="camera-dap-distance-container" class="hidden">
                    <div class="flex items-center gap-2">
                        <input type="number" id="camera-dap-distance-input" placeholder="Distancia (m)" class="input-field w-full border rounded-md p-3 outline-none transition text-base">
                        <button id="camera-dap-continue-btn" class="w-auto bg-sky-600 hover:bg-sky-700 font-semibold py-3 px-5 rounded-lg transition duration-300">OK</button>
                    </div>
                </div>
                <div id="camera-action-buttons" class="grid grid-cols-2 gap-2">
                    <button id="camera-capture-btn" class="w-full bg-lime-600 hover:bg-lime-700 font-semibold py-3 px-4 rounded-lg transition duration-300 col-span-2"></button>
                    <button id="camera-calculate-btn" class="hidden w-full bg-green-600 hover:bg-green-700 font-semibold py-3 px-4 rounded-lg transition duration-300 col-span-2">Calcular y Guardar</button>
                </div>
                <button id="camera-cancel-btn" class="w-full bg-red-600/80 hover:bg-red-700 font-semibold py-2 px-4 rounded-lg transition duration-300 text-sm">Cancelar Medición</button>
            </div>
        </div>
    </div>

    <div id="measurement-help-modal" class="modal hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="bg-slate-800 rounded-lg p-6 shadow-xl max-w-lg w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-white">Guía de Medición de Altura</h3>
                <button id="measurement-help-close" class="p-1 rounded-full hover:bg-white/10 text-2xl leading-none">&times;</button>
            </div>
            <div class="space-y-4 text-sm text-slate-300 max-h-[70vh] overflow-y-auto custom-scrollbar pr-2">
                <svg class="w-full h-auto bg-slate-900 rounded-lg p-4" viewBox="0 0 200 120">
                    <!-- Ground -->
                    <line x1="0" y1="110" x2="200" y2="110" stroke="#94a3b8" stroke-width="1"/>
                    <!-- Tree -->
                    <line x1="160" y1="20" x2="160" y2="110" stroke="#a3e635" stroke-width="2"/>
                    <path d="M 150 25 C 155 15, 165 15, 170 25 Z" fill="#65a30d"/>
                    <path d="M 148 35 C 155 25, 165 25, 172 35 Z" fill="#65a30d"/>
                    <!-- Person -->
                    <circle cx="40" cy="95" r="5" fill="#38bdf8"/>
                    <line x1="40" y1="100" x2="40" y2="110" stroke="#38bdf8" stroke-width="2"/>
                    <!-- Lines of sight -->
                    <line x1="40" y1="95" x2="160" y2="20" stroke="#f87171" stroke-width="0.5" stroke-dasharray="2,2"/>
                    <line x1="40" y1="95" x2="160" y2="110" stroke="#f87171" stroke-width="0.5" stroke-dasharray="2,2"/>
                    <!-- Horizontal line -->
                    <line x1="40" y1="95" x2="160" y2="95" stroke="white" stroke-width="0.5"/>
                    <!-- Angles -->
                    <path d="M 60 95 A 20 20 0 0 1 56.18 75.6" fill="none" stroke="#f87171" stroke-width="0.5"/>
                    <path d="M 60 95 A 20 20 0 0 0 58.82 105.5" fill="none" stroke="#f87171" stroke-width="0.5"/>
                    <!-- Labels -->
                    <text x="70" y="80" font-family="monospace" font-size="8" fill="white">Ángulo a la Copa (positivo)</text>
                    <text x="70" y="108" font-family="monospace" font-size="8" fill="white">Ángulo a la Base (negativo)</text>
                    <text x="80" y="118" font-family="monospace" font-size="8" fill="white">Distancia Horizontal</text>
                </svg>
                <div>
                    <h4 class="font-semibold text-lime-300">Consejos para una Medición Precisa:</h4>
                    <ul class="list-disc list-inside mt-2 pl-2 text-xs space-y-2">
                        <li><b>Mantén el Teléfono Vertical:</b> Sujeta el teléfono derecho, sin inclinarlo hacia los lados.</li>
                        <li><b>No te Muevas:</b> Mide ambos ángulos (base y copa) desde el mismo punto exacto.</li>
                        <li><b>Terreno Inclinado:</b> Si estás en una pendiente, la precisión puede disminuir. Para mejores resultados, intenta medir desde un punto que esté al mismo nivel que la base del árbol.</li>
                        <li><b>Verifica los Ángulos:</b> Para que el cálculo funcione, el ángulo a la copa debe ser mayor que el ángulo a la base (ej: Copa 25°, Base -5°).</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div id="ruma-help-modal" class="modal hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="bg-slate-800 rounded-lg p-6 shadow-xl max-w-lg w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-white">Guía de Medición de Trozos (Pino)</h3>
                <button id="ruma-help-close" class="p-1 rounded-full hover:bg-white/10 text-2xl leading-none">&times;</button>
            </div>
            <div class="space-y-6">
                <div>
                    <h4 class="font-semibold text-lime-300 mb-2">Método de Smalian</h4>
                    <p class="text-sm text-slate-300 mb-3">Mide los diámetros en ambos extremos del trozo (mayor y menor).</p>
                    <svg class="w-full h-auto bg-slate-900 rounded-lg p-4" viewBox="0 0 200 50">
                        <path d="M 10 10 L 190 5 L 190 45 L 10 40 Z" fill="#6B4F3A" stroke="#4A3728" stroke-width="1"/>
                        <line x1="10" y1="10" x2="10" y2="40" stroke="white" stroke-width="0.5"/>
                        <line x1="8" y1="10" x2="12" y2="10" stroke="white" stroke-width="0.5"/>
                        <line x1="8" y1="40" x2="12" y2="40" stroke="white" stroke-width="0.5"/>
                        <text x="15" y="28" font-family="monospace" font-size="8" fill="white">d1</text>
                        <line x1="190" y1="5" x2="190" y2="45" stroke="white" stroke-width="0.5"/>
                        <line x1="188" y1="5" x2="192" y2="5" stroke="white" stroke-width="0.5"/>
                        <line x1="188" y1="45" x2="192" y2="45" stroke="white" stroke-width="0.5"/>
                        <text x="175" y="28" font-family="monospace" font-size="8" fill="white">d2</text>
                    </svg>
                    <p class="text-xs text-slate-300 mt-2"><b>D. Mayor (cm):</b> Diámetro en el extremo más grueso. <b>D. Menor (cm):</b> Diámetro en el extremo más delgado.</p>
                </div>
                <div>
                    <h4 class="font-semibold text-lime-300 mb-2">Método de Huber</h4>
                    <p class="text-sm text-slate-300 mb-3">Mide el diámetro justo en el centro del trozo.</p>
                     <svg class="w-full h-auto bg-slate-900 rounded-lg p-4" viewBox="0 0 200 50">
                        <path d="M 10 10 L 190 5 L 190 45 L 10 40 Z" fill="#6B4F3A" stroke="#4A3728" stroke-width="1"/>
                        <line x1="100" y1="7.5" x2="100" y2="42.5" stroke="white" stroke-width="0.5"/>
                        <line x1="98" y1="7.5" x2="102" y2="7.5" stroke="white" stroke-width="0.5"/>
                        <line x1="98" y1="42.5" x2="102" y2="42.5" stroke="white" stroke-width="0.5"/>
                        <text x="105" y="28" font-family="monospace" font-size="8" fill="white">dc</text>
                    </svg>
                    <p class="text-xs text-slate-300 mt-2"><b>Diámetro Central (cm):</b> Diámetro medido a la mitad del largo del trozo.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- START: New Plot Help Modal -->
    <div id="plot-help-modal" class="modal hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="bg-slate-800 rounded-lg p-6 shadow-xl max-w-lg w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-white">Guía de Muestreo: Parcelas por Hectárea</h3>
                <button id="plot-help-close" class="p-1 rounded-full hover:bg-white/10 text-2xl leading-none">&times;</button>
            </div>
            <div class="space-y-4 text-sm text-slate-300 text-left max-h-96 overflow-y-auto custom-scrollbar pr-2">
                <p class="text-xs opacity-70 mb-4">La cantidad de parcelas depende del área de cada una y de la variabilidad del bosque (tamaños de árboles, mezcla de especies).</p>
                <div>
                    <h4 class="font-semibold text-lime-300 mb-2">1. Bosque Uniforme (Baja variabilidad)</h4>
                    <p class="text-xs">Árboles de la misma especie con tamaños y edades similares.</p>
                    <ul class="list-disc list-inside mt-2 pl-2 text-xs space-y-1">
                        <li><b>100m²:</b> 10 a 15 parcelas/ha</li>
                        <li><b>200m²:</b> 5 a 8 parcelas/ha</li>
                        <li><b>250m²:</b> 4 a 6 parcelas/ha</li>
                        <li><b>500m²:</b> 2 a 3 parcelas/ha</li>
                        <li><b>1000m²:</b> 1 a 2 parcelas/ha</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold text-lime-300 mb-2">2. Bosque con Variabilidad Media</h4>
                    <p class="text-xs">Árboles de la misma especie con tamaños y edades variables.</p>
                    <ul class="list-disc list-inside mt-2 pl-2 text-xs space-y-1">
                        <li><b>100m²:</b> 20 a 30 parcelas/ha</li>
                        <li><b>200m²:</b> 10 a 15 parcelas/ha</li>
                        <li><b>250m²:</b> 8 a 12 parcelas/ha</li>
                        <li><b>500m²:</b> 4 a 6 parcelas/ha</li>
                        <li><b>1000m²:</b> 2 a 3 parcelas/ha</li>
                    </ul>
                </div>
                 <div>
                    <h4 class="font-semibold text-lime-300 mb-2">3. Bosque con Alta Variabilidad</h4>
                    <p class="text-xs">Alta variabilidad inter-especie (mezcla de especies) y alta variabilidad intra-especie(diferentes tamaños y edades).</p>
                    <ul class="list-disc list-inside mt-2 pl-2 text-xs space-y-1">
                        <li><b>100m²:</b> 30 a 50 parcelas/ha</li>
                        <li><b>200m²:</b> 15 a 25 parcelas/ha</li>
                        <li><b>250m²:</b> 12 a 20 parcelas/ha</li>
                        <li><b>500m²:</b> 6 a 10 parcelas/ha</li>
                        <li><b>1000m²:</b> 3 a 5 parcelas/ha</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <!-- END: New Plot Help Modal -->

    <div id="generic-modal" class="modal hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="bg-slate-800 rounded-lg p-6 shadow-xl max-w-sm w-full text-center">
            <h3 id="generic-modal-title" class="text-lg font-bold text-white mb-2"></h3>
            <div id="generic-modal-body" class="text-slate-300 mb-6"></div>
            <div id="generic-modal-buttons" class="flex justify-center space-x-4">
                <!-- Buttons will be inserted here dynamically -->
            </div>
        </div>
    </div>
    <!-- END: Modals (pop-up windows) -->
    <!-- END: MAIN HTML STRUCTURE -->


    <script>
        /* --- START: JAVASCRIPT LOGIC SECTION --- */
        (function() {
            /* --- SUB-SECTION: PWA & OFFLINE CONFIGURATION --- */
            
            // The Service Worker code is defined here as a string to be registered later.
            const serviceWorkerCode = `
                // Import Workbox from Google's CDN
                importScripts('https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-sw.js');

                // Set a cache name for the maps
                const MAP_CACHE_NAME = 'map-tiles';

                // Ensure Workbox is loaded
                if (workbox) {
                  console.log('Yay! Workbox is loaded 🎉');

                  // --- MAP CACHE STRATEGY ---
                  // Capture all requests to the map server domain
                  workbox.routing.registerRoute(
                    ({url}) => url.hostname === 'server.arcgisonline.com',
                    // Use CacheFirst strategy: if the map tile is in the cache, serve it from there.
                    // If not, fetch it from the network, display it, and save it to the cache for next time.
                    new workbox.strategies.CacheFirst({
                      cacheName: MAP_CACHE_NAME,
                      plugins: [
                        // Cache only successful responses (status 200)
                        new workbox.cacheableResponse.CacheableResponsePlugin({
                          statuses: [0, 200],
                        }),
                        // Limit the number of saved tiles to avoid filling up device storage
                        new workbox.expiration.ExpirationPlugin({
                          maxEntries: 500, // Maximum 500 map images
                          maxAgeSeconds: 30 * 24 * 60 * 60, // Keep for 30 days
                        }),
                      ],
                    })
                  );

                  // --- APP SHELL CACHE STRATEGY ---
                  // Cache the main application files (HTML, CSS, JS).
                  workbox.routing.registerRoute(
                    ({request}) => request.destination === 'document' ||
                                   request.destination === 'style' ||
                                   request.destination === 'script' ||
                                   request.destination === 'worker',
                    // Use StaleWhileRevalidate: serve from cache for a fast load,
                    // but update the cache in the background if there's a connection.
                    new workbox.strategies.StaleWhileRevalidate({
                      cacheName: 'app-shell',
                    })
                  );

                } else {
                  console.log('Boo! Workbox did not load 😬');
                }
            `;

            // Create a "virtual file" in memory for the Service Worker
            const swBlob = new Blob([serviceWorkerCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(swBlob);

            // Register the Service Worker
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register(swUrl).then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    }, err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
                });
            }
            /* --- END: SUB-SECTION: PWA & OFFLINE CONFIGURATION --- */

            /* --- SUB-SECTION: GLOBAL STATE & CONSTANTS --- */
            const AppState = {
                calculatedVolumes: { pino: 0, eucaliptoSolid: 0, eucaliptoRuma: 0 },
                dasometricReportData: {},
                gpsWatchId: null,
                map: null,
                userMarker: null,
                accuracyCircle: null,
                activeProject: null,
                activeProjectPrice: '',
                hasUnsavedChanges: false,
                currentRumaEntries: [],
                lastRumaCalculation: null,
                lastKnownPosition: null, // Will store { position, timestamp }
                magneticDeclination: 0,
                drawControl: null,
                drawnLayer: null,
                polygonDrawer: null,
                compassHistory: []
            };
            const COMMERCIAL_FACTOR = 0.82;
            const RUMA_FACTOR = 0.65;
            const ASSUMED_CAMERA_FOV = 60; // Horizontal Field of View in degrees
            const COMPASS_SMOOTHING_SAMPLES = 10;
            /* --- END: SUB-SECTION: GLOBAL STATE & CONSTANTS --- */
            
            /* --- SUB-SECTION: DOM ELEMENTS --- */
            const appContainer = document.getElementById('app-container');
            const projectTitleRuma = document.getElementById('ruma-project-title');
            const projectTitlePlot = document.getElementById('plot-project-title');
            const resultContainer = document.getElementById('result-container');
            const resultTitle = document.getElementById('result-title');
            const resultValue = document.getElementById('result-value');
            const valueCalculator = document.getElementById('value-calculator');
            const priceInput = document.getElementById('price');
            const priceSpeciesSelect = document.getElementById('price-species');
            const valueResultContainer = document.getElementById('value-result-container');
            const valueResult = document.getElementById('value-result');
            const exportPdfBtn = document.getElementById('export-pdf-btn');
            const exportCsvBtn = document.getElementById('export-csv-btn');
            const themeToggle = document.getElementById('theme-toggle');
            const themeIconSun = document.getElementById('theme-icon-sun');
            const themeIconMoon = document.getElementById('theme-icon-moon');
            const plotList = document.getElementById('plotList');
            const saveProjectBtn = document.getElementById('save-project-btn');
            const newProjectBtn = document.getElementById('new-project-btn');
            const loadProjectBtn = document.getElementById('load-project-btn');
            const dapInput = document.getElementById('dap');
            const heightInput = document.getElementById('height');
            const plotProjectSummary = document.getElementById('plot-project-summary');
            const plotTotalVolume = document.getElementById('plot-total-volume');
            const viewPlotDetailsBtn = document.getElementById('view-plot-details-btn');
            const restoreModal = document.getElementById('restore-session-modal');
            const saveModal = document.getElementById('save-project-modal');
            const loadModal = document.getElementById('load-project-modal');
            const rumaHistoryModal = document.getElementById('ruma-history-modal');
            const rumaHelpModal = document.getElementById('ruma-help-modal');
            const plotHelpModal = document.getElementById('plot-help-modal');
            const measurementHelpModal = document.getElementById('measurement-help-modal');
            const restoreYesBtn = document.getElementById('restore-yes');
            const restoreNoBtn = document.getElementById('restore-no');
            const rumaHelpClose = document.getElementById('ruma-help-close');
            const plotHelpClose = document.getElementById('plot-help-close');
            const rumaProjectSummary = document.getElementById('ruma-project-summary');
            const rumaTotalVolumeContainer = document.getElementById('ruma-total-volume');
            const viewRumaHistoryBtn = document.getElementById('view-ruma-history-btn');
            const addRumaToProjectBtn = document.getElementById('add-ruma-to-project-btn');
            const rumaMovementTypeSelect = document.getElementById('ruma_movement_type');
            const rumaEntryContainer = document.getElementById('ruma-entry-container');
            const rumaSaleContainer = document.getElementById('ruma-sale-container');
            const rumaSaleVolumeInput = document.getElementById('ruma_sale_volume');
            const rumaSaleUnitPriceInput = document.getElementById('ruma_sale_unit_price');
            const rumaSaleTotalIncomeDisplay = document.getElementById('ruma_sale_total_income');
            const rumaHelpBtn = document.getElementById('ruma-help-btn');
            const mapContainer = document.getElementById('map-container');
            const mapExpandBtn = document.getElementById('map-expand-btn');
            const mapCloseBtn = document.getElementById('map-close-btn');
            const activateSensorsBtn = document.getElementById('activate-sensors-btn');
            const sensorsContent = document.getElementById('sensors-content');
            const activateSensorsContainer = document.getElementById('activate-sensors-container');
            const sensorsError = document.getElementById('sensors-error');
            const compassRose = document.getElementById('compass-rose');
            const azimuthDisplay = document.getElementById('azimuth');
            const directionDisplay = document.getElementById('direction');
            const latitudeDisplay = document.getElementById('latitude');
            const longitudeDisplay = document.getElementById('longitude');
            const accuracyDisplay = document.getElementById('accuracy');
            const measureTreeBtn = document.getElementById('measure-tree-btn');
            const cameraMeasurementModal = document.getElementById('camera-measurement-modal');
            const cameraFeed = document.getElementById('camera-feed');
            const cameraStepTitle = document.getElementById('camera-step-title');
            const cameraInstructions = document.getElementById('camera-instructions');
            const cameraCaptureBtn = document.getElementById('camera-capture-btn');
            const cameraDapBtn = document.getElementById('camera-dap-btn');
            const cameraCalculateBtn = document.getElementById('camera-calculate-btn');
            const cameraCancelBtn = document.getElementById('camera-cancel-btn');
            const dapLinesContainer = document.getElementById('dap-lines-container');
            const cameraReticle = document.getElementById('camera-reticle');
            const liveAngleDisplay = document.getElementById('live-angle-display');
            const drawingToolsContainer = document.getElementById('drawing-tools-container');
            const startDrawBtn = document.getElementById('start-draw-btn');
            const undoDrawBtn = document.getElementById('undo-draw-btn');
            const searchRolBtn = document.getElementById('search-rol-btn');
            const drawingResultsContainer = document.getElementById('drawing-results-container');
            const calculatedArea = document.getElementById('calculated-area');
            const calculatedPerimeter = document.getElementById('calculated-perimeter');
            const useAreaBtn = document.getElementById('use-area-btn');
            const exportMapPdfBtn = document.getElementById('export-map-pdf-btn');
            /* --- END: SUB-SECTION: DOM ELEMENTS --- */

            // --- MODULE: CalculationEngine ---
            const CalculationEngine = {
                
                // --- SUB-SECTION: CORE CALCULATION LOGIC ---
                calculateTreeVolume(species, dap, height, method, volumeType) {
                    let volume = 0;
                    if (method === 'equation') {
                        volume = (species === 'pino')
                            ? -0.00501 + 0.0000412 * Math.pow(dap, 2) * height
                            : 0.00318 + 0.0000451 * Math.pow(dap, 2) * height;
                    } else { // Form Factor
                        const dap_m = dap / 100;
                        const ff = (species === 'pino') ? 0.53 : 0.60;
                        volume = (Math.PI / 4) * Math.pow(dap_m, 2) * height * ff;
                    }
                    volume = Math.max(0, volume);
                    if (volumeType === 'commercial') {
                        volume *= COMMERCIAL_FACTOR;
                    }
                    return volume;
                },

                calculateStandingTreeVolume() {
                    const species = document.getElementById('species').value;
                    const method = document.getElementById('standingMethod').value;
                    const volumeType = document.getElementById('standingVolumeType').value;
                    const dap = parseFloat(dapInput.value);
                    const height = parseFloat(heightInput.value);
                    resultTitle.textContent = 'Volumen Estimado del Árbol';

                    if (!dap || !height || dap <= 0 || height <= 0) {
                        return false;
                    }

                    const volume = this.calculateTreeVolume(species, dap, height, method, volumeType);

                    if (species.includes('globulus')) {
                        AppState.calculatedVolumes.eucaliptoSolid = volume;
                        AppState.calculatedVolumes.eucaliptoRuma = volume / RUMA_FACTOR;
                        resultValue.innerHTML = `<div>${(volume / RUMA_FACTOR).toFixed(4)} metros ruma</div><div class="text-sm opacity-70 mt-1">${volume.toFixed(4)} m³ sólido</div>`;
                    } else {
                        AppState.calculatedVolumes.pino = volume;
                        resultValue.innerHTML = `<p>${volume.toFixed(4)} m³</p>`;
                    }
                    return true;
                },

                calculatePlotVolume() {
                    resultTitle.textContent = 'Resultados de Cubicación de Bosque';
                    const plotCards = plotList.querySelectorAll('.plot-card');
                    const totalAreaHa = parseFloat(document.getElementById('totalAreaHa').value) || 0;

                    if (plotCards.length === 0) return false;

                    const reportData = {
                        speciesData: {},
                        treeDetails: [],
                        totalPlots: plotCards.length
                    };

                    let pinoTotalVolHa = 0, pinoPlots = 0;
                    let eucaSolidTotalVolHa = 0, eucaRumaTotalVolHa = 0, eucaPlots = 0;
                    let allPlotsInvalid = true;

                    plotCards.forEach((card, pIndex) => {
                        const species = card.querySelector('.plot-species').value;
                        const plotSize = parseFloat(card.querySelector('.plot-size').value); // m²
                        const method = card.querySelector('.plot-method').value;
                        const volumeType = card.querySelector('.plot-volume-type').value;
                        const coords = card.dataset.coords || null;

                        if (isNaN(plotSize) || plotSize <= 0) return;

                        if (!reportData.speciesData[species]) {
                            reportData.speciesData[species] = {
                                treeCount: 0,
                                plotCount: 0,
                                totalPlotArea: 0,
                                sumDapSq: 0,
                                totalBasalArea: 0,
                                totalVolume: 0,
                                unit: species.includes('pino') ? 'm³' : 'mr'
                            };
                        }
                        
                        let plotTreeCount = 0;
                        card.querySelectorAll('.tree-list-container > div').forEach((treeEl, tIndex) => {
                            const dap = parseFloat(treeEl.querySelector('.tree-dap').value);
                            const height = parseFloat(treeEl.querySelector('.tree-height').value);
                            if (!dap || !height || dap <= 0 || height <= 0) return;
                            
                            plotTreeCount++;
                            allPlotsInvalid = false;
                            
                            const volume = this.calculateTreeVolume(species, dap, height, method, volumeType);
                            const basalArea = (Math.PI / 4) * Math.pow(dap / 100, 2);

                            reportData.speciesData[species].sumDapSq += dap * dap;
                            reportData.speciesData[species].totalBasalArea += basalArea;
                            reportData.speciesData[species].totalVolume += volume;

                            reportData.treeDetails.push({
                                plotId: pIndex + 1,
                                treeId: tIndex + 1,
                                species,
                                dap,
                                height,
                                volume,
                                coords
                            });
                        });
                        
                        if (plotTreeCount > 0) {
                            reportData.speciesData[species].treeCount += plotTreeCount;
                            reportData.speciesData[species].plotCount++;
                            reportData.speciesData[species].totalPlotArea += plotSize;
                        }
                    });

                    if (allPlotsInvalid) {
                        AppState.dasometricReportData = {};
                        return false;
                    }

                    for (const species in reportData.speciesData) {
                        const data = reportData.speciesData[species];
                        const totalHaForSpecies = data.totalPlotArea / 10000;
                        data.N = data.treeCount / totalHaForSpecies;
                        data.G = data.totalBasalArea / totalHaForSpecies;
                        data.DMC = Math.sqrt(data.sumDapSq / data.treeCount);
                        
                        if (species.includes('pino')) {
                            data.Vol = data.totalVolume / totalHaForSpecies;
                            pinoTotalVolHa += data.Vol * data.plotCount;
                            pinoPlots += data.plotCount;
                        } else {
                            const volSolidHa = data.totalVolume / totalHaForSpecies;
                            data.Vol = volSolidHa / RUMA_FACTOR;
                            eucaSolidTotalVolHa += volSolidHa * data.plotCount;
                            eucaRumaTotalVolHa += data.Vol * data.plotCount;
                            eucaPlots += data.plotCount;
                        }
                    }

                    AppState.dasometricReportData = reportData;

                    let resultHTML = '<table class="w-full text-left result-table">';
                    resultHTML += '<thead><tr><th>Especie</th><th>Vol/ha</th><th>Vol Total</th></tr></thead><tbody>';
                    
                    if (pinoPlots > 0) {
                        const avg = pinoTotalVolHa / pinoPlots;
                        AppState.calculatedVolumes.pino = avg;
                        resultHTML += `<tr><td>Pino</td><td>${avg.toFixed(2)} m³/ha</td><td>${(avg * totalAreaHa).toFixed(2)} m³</td></tr>`;
                    }
                    if (eucaPlots > 0) {
                        const avgSolid = eucaSolidTotalVolHa / eucaPlots;
                        const avgRuma = eucaRumaTotalVolHa / eucaPlots;
                        AppState.calculatedVolumes.eucaliptoSolid = avgSolid;
                        AppState.calculatedVolumes.eucaliptoRuma = avgRuma;
                        resultHTML += `<tr><td>Eucalipto</td><td>${avgRuma.toFixed(2)} mr/ha</td><td>${(avgRuma * totalAreaHa).toFixed(2)} mr</td></tr>`;
                    }
                    resultHTML += '</tbody></table>';

                    resultValue.innerHTML = resultHTML;
                    return true;
                },
                
                processRumaMovement() {
                    const movementType = rumaMovementTypeSelect.value;
                    const now = new Date();
                    const pad = (num) => num.toString().padStart(2, '0');
                    const timestamp = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}`;
                    
                    if (movementType === 'entry') {
                        const species = document.getElementById('ruma_species').value;
                        if (species === 'eucalipto') {
                            resultTitle.textContent = 'Volumen de Entrada (Pila)';
                            const largoRuma = parseFloat(document.getElementById('ruma_largo').value);
                            const largoTrozoValue = document.getElementById('ruma_trozo_select').value;
                            let largoTrozo = largoTrozoValue === 'other' ? parseFloat(document.getElementById('ruma_trozo_other').value) : parseFloat(largoTrozoValue);
                            
                            let validHeights = 0, totalHeight = 0;
                            document.querySelectorAll('.ruma-height-input').forEach(input => {
                                const h = parseFloat(input.value);
                                if (h > 0) { totalHeight += h; validHeights++; }
                            });

                            if (!largoRuma || !largoTrozo || largoRuma <= 0 || largoTrozo <= 0 || validHeights === 0) return false;
                            
                            const avgHeight = totalHeight / validHeights;
                            const mr_face_area = largoRuma * avgHeight;
                            
                            const displayVol = mr_face_area * largoTrozo;
                            let standardVol = displayVol;
                            let details = `L:${largoRuma.toFixed(2)}m, H:${avgHeight.toFixed(2)}m, T:${largoTrozo.toFixed(2)}m`;
                            let faceVolume = null;

                            if (largoTrozo === 3.50) {
                                standardVol = mr_face_area * 2.44; 
                                faceVolume = displayVol;
                                resultValue.innerHTML = `<p>${displayVol.toFixed(2)} mr (a 3.50m)</p><p class="text-lg opacity-80 mt-1">Equivale a ${standardVol.toFixed(2)} mr (Estándar 2.44m)</p>`;
                                details = `L:${largoRuma.toFixed(2)}m, H:${avgHeight.toFixed(2)}m, T:3.50m`;
                            } else {
                                resultValue.innerHTML = `<p>${displayVol.toFixed(2)} metros ruma</p>`;
                            }
                            
                            AppState.lastRumaCalculation = {
                                type: 'entry', id: Date.now(), date: timestamp, vol: standardVol,
                                faceVolume: faceVolume, details: details, value: valueResult.textContent
                            };
                            AppState.calculatedVolumes.eucaliptoRuma = standardVol;
                            return true;

                        } else { // Pino
                            resultTitle.textContent = 'Volumen de Entrada (Trozo)';
                            let totalSolidVolume = 0;
                            const largoTrozoPinoValue = document.getElementById('ruma_pino_trozo_select').value;
                            const largoTrozoPino = largoTrozoPinoValue === 'other' ? parseFloat(document.getElementById('ruma_pino_trozo_other').value) : parseFloat(largoTrozoPinoValue);
                            
                            if (!largoTrozoPino || largoTrozoPino <= 0) return false;

                            let validLogs = 0;
                            document.querySelectorAll('#ruma_pino_logs_container .p-3').forEach(log => {
                                const length = largoTrozoPino;
                                let logVolume = 0;
                                if (document.getElementById('ruma_pino_method').value === 'huber') {
                                    const dCentralInput = log.querySelector('.ruma-log-d-central');
                                    if (dCentralInput) {
                                        const d_central = parseFloat(dCentralInput.value);
                                        if (d_central > 0) { logVolume = Math.PI * Math.pow(d_central / 200, 2) * length; validLogs++; }
                                    }
                                } else {
                                    const d1Input = log.querySelector('.ruma-log-d1');
                                    const d2Input = log.querySelector('.ruma-log-d2');
                                    if (d1Input && d2Input) {
                                        const d1 = parseFloat(d1Input.value);
                                        const d2 = parseFloat(d2Input.value);
                                        if (d1 > 0 && d2 > 0) { logVolume = ((Math.PI * Math.pow(d1 / 200, 2)) + (Math.PI * Math.pow(d2 / 200, 2))) / 2 * length; validLogs++; }
                                    }
                                }
                                totalSolidVolume += logVolume;
                            });

                            if (validLogs > 0) {
                                resultValue.innerHTML = `<p>${totalSolidVolume.toFixed(4)} m³</p>`;
                                AppState.lastRumaCalculation = {
                                    type: 'entry', id: Date.now(), date: timestamp, vol: totalSolidVolume,
                                    details: `${validLogs} trozos de ${largoTrozoPino}m`, value: valueResult.textContent
                                };
                                AppState.calculatedVolumes.pino = totalSolidVolume;
                                return true;
                            }
                            return false;
                        }
                    } else { // Sale
                        resultTitle.textContent = 'Registro de Salida por Venta';
                        const saleVolume = parseFloat(rumaSaleVolumeInput.value);
                        const unitPrice = parseFloat(rumaSaleUnitPriceInput.value);
                        const client = document.getElementById('ruma_sale_client').value.trim();

                        if (!saleVolume || saleVolume <= 0) return false;
                        
                        const totalIncome = (saleVolume || 0) * (unitPrice || 0);
                        const unit = document.getElementById('ruma_species').value === 'pino' ? 'm³' : 'mr';
                        resultValue.innerHTML = `<p>-${saleVolume.toFixed(2)} ${unit}</p><p class="text-lg opacity-80 mt-1">Ingreso: ${totalIncome.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' })}</p>`;
                        
                        AppState.lastRumaCalculation = {
                            type: 'sale', id: Date.now(), date: timestamp, vol: -saleVolume,
                            unitPrice: unitPrice || 0, salePrice: totalIncome, client: client || 'N/A'
                        };
                        return true;
                    }
                },

                // --- SUB-SECTION: MONETARY VALUE CALCULATOR ---
                syncPriceCalculatorSpecies() {
                    const activeTab = document.querySelector('input[name="tabs"]:checked').id;
                    let currentSpecies = 'pino';

                    if (activeTab === 'tab-ruma' || (AppState.activeProject && AppState.activeProject.data.type === 'ruma')) {
                        currentSpecies = document.getElementById('ruma_species').value;
                    } else if (activeTab === 'tab-plot' || (AppState.activeProject && AppState.activeProject.data.type === 'bosque')) {
                        const firstPlotSpeciesEl = plotList.querySelector('.plot-species');
                        if (firstPlotSpeciesEl) currentSpecies = firstPlotSpeciesEl.value;
                    } else if (activeTab === 'tab-standing') {
                        currentSpecies = document.getElementById('species').value;
                    }
                    
                    priceSpeciesSelect.value = currentSpecies.includes('pino') ? 'pino' : 'eucalipto';
                },

                calculateValue() {
                    this.syncPriceCalculatorSpecies();
                    const price = parseFloat(priceInput.value) || 0;
                    
                    valueResultContainer.classList.remove('hidden');

                    if (!price || price <= 0) {
                        valueResult.textContent = '$0';
                        UIManager.updatePlotSummary();
                        return;
                    }

                    let totalValue = 0;
                    const totalAreaHa = parseFloat(document.getElementById('totalAreaHa').value) || 0;
                    let volumeForCalc = (priceSpeciesSelect.value === 'pino') ? AppState.calculatedVolumes.pino : AppState.calculatedVolumes.eucaliptoRuma;
                    
                    const activeTab = document.querySelector('input[name="tabs"]:checked').id;
                    if(activeTab === 'tab-plot') { 
                        volumeForCalc *= totalAreaHa;
                    }
                    
                    totalValue = price * volumeForCalc;
                    
                    valueResult.textContent = `$${totalValue.toLocaleString('es-CL', { maximumFractionDigits: 0 })}`;
                    UIManager.updatePlotSummary();
                },
                
                updateSaleIncomeDisplay() {
                    const volume = parseFloat(rumaSaleVolumeInput.value) || 0;
                    const unitPrice = parseFloat(rumaSaleUnitPriceInput.value) || 0;
                    const totalIncome = volume * unitPrice;
                    rumaSaleTotalIncomeDisplay.textContent = totalIncome.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' });
                }
            };

            // --- MODULE: UIManager ---
            const UIManager = {
                // --- SUB-SECTION: UTILITY & THEME ---
                getOS() {
                    const ua = navigator.userAgent;
                    if (/android/i.test(ua)) return "Android";
                    if (/iPad|iPhone|iPod/.test(ua)) return "iOS";
                    return "Other";
                },
                
                loadScript(src) {
                    return new Promise((resolve, reject) => {
                        if (document.querySelector(`script[src="${src}"]`)) {
                            resolve(); return;
                        }
                        const script = document.createElement('script');
                        script.src = src;
                        script.onload = resolve;
                        script.onerror = reject;
                        document.head.appendChild(script);
                    });
                },

                loadCss(href) {
                    return new Promise((resolve, reject) => {
                         if (document.querySelector(`link[href="${href}"]`)) {
                            resolve(); return;
                        }
                        const link = document.createElement('link');
                        link.rel = 'stylesheet';
                        link.href = href;
                        link.onload = resolve;
                        link.onerror = reject;
                        document.head.appendChild(link);
                    });
                },
                
                toggleModal(modal, show) {
                    if (show) {
                        document.body.classList.add('modal-open');
                        modal.classList.remove('hidden');
                        setTimeout(() => modal.classList.remove('opacity-0', 'pointer-events-none'), 10);
                    } else {
                        document.body.classList.remove('modal-open');
                        modal.classList.add('opacity-0', 'pointer-events-none');
                        setTimeout(() => modal.classList.add('hidden'), 250);
                    }
                },

                showCustomModal(title, message, buttons) {
                    const modal = document.getElementById('generic-modal');
                    document.getElementById('generic-modal-title').textContent = title;
                    document.getElementById('generic-modal-body').innerHTML = `<p>${message}</p>`;
                    const buttonContainer = document.getElementById('generic-modal-buttons');
                    buttonContainer.innerHTML = '';

                    buttons.forEach(btnConfig => {
                        const button = document.createElement('button');
                        button.textContent = btnConfig.text;
                        button.className = btnConfig.classes;
                        button.onclick = () => {
                            this.toggleModal(modal, false);
                            if (btnConfig.onClick) btnConfig.onClick();
                        };
                        buttonContainer.appendChild(button);
                    });

                    this.toggleModal(modal, true);
                },
                
                showInputModal(title, message, placeholder) {
                    return new Promise((resolve) => {
                        const modal = document.getElementById('generic-modal');
                        document.getElementById('generic-modal-title').textContent = title;
                        const body = document.getElementById('generic-modal-body');
                        body.innerHTML = `<p class="text-slate-300 mb-4">${message}</p>
                                          <input type="text" id="modal-input-field" placeholder="${placeholder}" class="input-field w-full border rounded-md p-3 outline-none transition">`;
                        
                        const buttonContainer = document.getElementById('generic-modal-buttons');
                        buttonContainer.innerHTML = '';

                        const confirmBtn = document.createElement('button');
                        confirmBtn.textContent = 'Confirmar';
                        confirmBtn.className = 'bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition';
                        confirmBtn.onclick = () => {
                            const value = document.getElementById('modal-input-field').value;
                            this.toggleModal(modal, false);
                            resolve(value.trim());
                        };
                        buttonContainer.appendChild(confirmBtn);
                        
                        const cancelBtn = document.createElement('button');
                        cancelBtn.textContent = 'Cancelar';
                        cancelBtn.className = 'bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg transition';
                        cancelBtn.onclick = () => {
                            this.toggleModal(modal, false);
                            resolve(null); // Resolve with null on cancel
                        };
                        buttonContainer.appendChild(cancelBtn);

                        this.toggleModal(modal, true);
                        document.getElementById('modal-input-field').focus();
                    });
                },

                applyInitialTheme() {
                    const savedTheme = localStorage.getItem('cubiforTheme');
                    if (savedTheme === 'high') {
                        appContainer.classList.add('high-contrast');
                        themeIconSun.classList.add('hidden');
                        themeIconMoon.classList.remove('hidden');
                    }
                },

                // --- SUB-SECTION: DYNAMIC UI HANDLING ---
                handleTabChange() {
                    const activeTab = document.querySelector('input[name="tabs"]:checked').id;
                    document.getElementById('standingContent').classList.toggle('hidden', activeTab !== 'tab-standing');
                    document.getElementById('plotContent').classList.toggle('hidden', activeTab !== 'tab-plot');
                    document.getElementById('rumaContent').classList.toggle('hidden', activeTab !== 'tab-ruma');
                    document.getElementById('navContent').classList.toggle('hidden', activeTab !== 'tab-nav');

                    const activeTabType = activeTab === 'tab-plot' ? 'bosque' : (activeTab === 'tab-ruma' ? 'ruma' : null);
                    if (AppState.activeProject && AppState.activeProject.data.type === activeTabType) {
                        priceInput.value = AppState.activeProjectPrice;
                    } else {
                        priceInput.value = '';
                    }
                    
                    const projectButtonsVisible = (activeTab === 'tab-plot' || activeTab === 'tab-ruma');
                    saveProjectBtn.classList.toggle('hidden', !projectButtonsVisible);
                    newProjectBtn.classList.toggle('hidden', !projectButtonsVisible);
                    loadProjectBtn.classList.toggle('hidden', !projectButtonsVisible);

                    if (activeTab === 'tab-nav') {
                        resultContainer.classList.add('hidden');
                        if (AppState.map) {
                            setTimeout(() => AppState.map.invalidateSize(), 10);
                        }
                    } else {
                        SensorManager.stopNavigationSensors();
                        calculateAndDisplay();
                    }
                },
                
                updateListUI(container, labelSelector, labelPrefix) {
                    if (!container) return;
                    const entries = container.querySelectorAll('.removable-entry');
                    entries.forEach((entry, index) => {
                        const label = entry.querySelector(labelSelector);
                        if (label) label.textContent = `${labelPrefix}${index + 1}.`;
                        const removeBtn = entry.querySelector('.remove-btn');
                        if (removeBtn) removeBtn.style.visibility = entries.length > 1 ? 'visible' : 'hidden';
                    });
                },

                updatePlotCardsUI() {
                    const plotCards = plotList.querySelectorAll('.plot-card');
                    plotCards.forEach((card, index) => {
                        const title = card.querySelector('.plot-title');
                        if (title) title.textContent = `Parcela ${index + 1}`;
                        const removeBtn = card.querySelector('.remove-plot-btn');
                        if (removeBtn) removeBtn.style.visibility = plotCards.length > 1 ? 'visible' : 'hidden';
                    });
                },

                createRumaHeightEntry() {
                    const container = document.getElementById('ruma_heights_container');
                    const entry = document.createElement('div');
                    entry.className = 'flex items-center space-x-2 removable-entry';
                    entry.innerHTML = `<span class="text-sm opacity-70 w-6 text-center"></span><input type="number" min="0" placeholder="Altura (m)" class="ruma-height-input input-field w-full border rounded-md p-2 outline-none transition"><button class="remove-btn opacity-70 hover:text-red-500 transition-colors p-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg></button>`;
                    container.appendChild(entry);
                    this.updateListUI(container, 'span.w-6', '');
                },

                createRumaLogEntry() {
                    const container = document.getElementById('ruma_pino_logs_container');
                    const entry = document.createElement('div');
                    entry.className = 'p-3 bg-black/20 rounded-lg space-y-2 removable-entry';
                    const method = document.getElementById('ruma_pino_method').value;
                    let inputsHTML = method === 'huber' ? `<input type="number" min="0" placeholder="Diámetro Central (cm)" class="ruma-log-d-central input-field w-full border rounded-md p-2 outline-none transition">` : `<div class="flex space-x-2"><input type="number" min="0" placeholder="D. Mayor (cm)" class="ruma-log-d1 input-field w-full border rounded-md p-2 outline-none transition"><input type="number" min="0" placeholder="D. Menor (cm)" class="ruma-log-d2 input-field w-full border rounded-md p-2 outline-none transition"></div>`;
                    entry.innerHTML = `<div class="flex justify-between items-center"><span class="font-semibold text-sm opacity-70"></span><button class="remove-btn opacity-70 hover:text-red-500 transition-colors p-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg></button></div>${inputsHTML}`;
                    container.appendChild(entry);
                    this.updateListUI(container, '.font-semibold', 'Trozo ');
                },
                
                createTreeEntry(container) {
                    const entry = document.createElement('div');
                    entry.className = 'flex items-center space-x-2 removable-entry';
                    entry.innerHTML = `<span class="text-sm opacity-70 w-6 text-center"></span><input type="number" min="0" placeholder="DAP (cm)" class="tree-dap input-field w-full border rounded-md p-2 outline-none transition"><input type="number" min="0" placeholder="Altura (m)" class="tree-height input-field w-full border rounded-md p-2 outline-none transition"><button class="remove-btn opacity-70 hover:text-red-500 transition-colors p-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg></button>`;
                    container.appendChild(entry);
                    this.updateListUI(container, 'span.w-6', '');
                },
                
                createPlotEntry(plotData = null) {
                    const plotCard = document.createElement('div');
                    plotCard.className = 'plot-card bg-black/20 p-4 rounded-lg border border-inherit space-y-3';
                    plotCard.innerHTML = `<div class="flex justify-between items-center"><h3 class="plot-title font-semibold text-lg"></h3><button class="remove-plot-btn opacity-70 hover:text-red-500 transition-colors p-1 rounded-full hover:bg-white/10"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-3"><div><label class="block text-xs font-medium opacity-80 mb-1">Especie</label><select class="plot-species input-field w-full border rounded-md p-2 outline-none transition text-sm"><option value="pino">Pino</option><option value="globulus">E. Globulus</option></select></div><div><div class="flex items-center space-x-1 mb-1"><label class="block text-xs font-medium opacity-80">Superficie</label><button class="plot-help-btn p-1 rounded-full hover:bg-white/20 transition-colors" title="Guía de Muestreo"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></button></div><select class="plot-size input-field w-full border rounded-md p-2 outline-none transition text-sm"><option value="100" selected>100 m² (Radio: 5.64 m)</option><option value="200">200 m² (Radio: 7.98 m)</option><option value="250">250 m² (Radio: 8.92 m)</option><option value="500">500 m² (Radio: 12.62 m)</option><option value="1000">1000 m² (Radio: 17.84 m)</option></select></div></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-3"><div><label class="block text-xs font-medium opacity-80 mb-1">Volumen</label><select class="plot-volume-type input-field w-full border rounded-md p-2 outline-none transition text-sm"><option value="total">Total</option><option value="commercial">Comercial</option></select></div><div class="euca-unit-container hidden"><label class="block text-xs font-medium opacity-80 mb-1">Unidad</label><select class="plot-unit input-field w-full border rounded-md p-2 outline-none transition text-sm"><option value="cubic">m³</option><option value="ruma">metros ruma</option></select></div></div><div><label class="block text-xs font-medium opacity-80 mb-1">Método</label><select class="plot-method input-field w-full border rounded-md p-2 outline-none transition text-sm"><option value="equation" selected>Ecuación de Volumen (Recomendado)</option><option value="form_factor">Factor de Forma</option></select></div><div class="border-t border-inherit pt-3 mt-3"><button class="capture-coords-btn w-full bg-sky-800/50 hover:bg-sky-800/80 font-semibold py-2 px-4 rounded-lg transition duration-300 flex items-center justify-center space-x-2 text-sm border border-sky-700">📍 Capturar Coordenadas</button><p class="coords-display text-center text-xs opacity-70 mt-2 hidden"></p></div><div class="border-t border-inherit pt-3 mt-3"><h4 class="font-medium mb-2 opacity-80">Árboles</h4><div class="tree-list-container space-y-2 max-h-48 overflow-y-auto custom-scrollbar pr-1"></div><button class="add-tree-btn-plot mt-3 w-full bg-white/5 hover:bg-white/10 font-semibold py-2 px-4 rounded-lg transition duration-300 flex items-center justify-center space-x-2 text-sm border border-inherit"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110 2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg><span>Agregar Árbol</span></button></div>`;
                    plotList.appendChild(plotCard);
                    const treeContainer = plotCard.querySelector('.tree-list-container'); 
                    const captureCoordsBtn = plotCard.querySelector('.capture-coords-btn');

                    captureCoordsBtn.addEventListener('click', async () => {
                        const coordsDisplay = plotCard.querySelector('.coords-display');
                        const now = Date.now();
                        if (AppState.lastKnownPosition && (now - AppState.lastKnownPosition.timestamp < 15000)) {
                            const { latitude, longitude } = AppState.lastKnownPosition.position.coords;
                            const coords = `${latitude},${longitude}`;
                            plotCard.dataset.coords = coords;
                            coordsDisplay.textContent = `Lat: ${latitude.toFixed(5)}, Lon: ${longitude.toFixed(5)}`;
                            coordsDisplay.classList.remove('hidden');
                            UIManager.showCustomModal('Coordenadas Capturadas', `Se utilizó la última ubicación conocida del GPS.`, [{ text: 'OK', classes: 'bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition' }]);
                        } else {
                            try {
                                UIManager.showCustomModal('Capturando...', 'Obteniendo coordenadas GPS. Por favor, espere.', []);
                                const position = await SensorManager.requestGpsPermission();
                                const { latitude, longitude } = position.coords;
                                const coords = `${latitude},${longitude}`;
                                plotCard.dataset.coords = coords;
                                coordsDisplay.textContent = `Lat: ${latitude.toFixed(5)}, Lon: ${longitude.toFixed(5)}`;
                                coordsDisplay.classList.remove('hidden');
                                UIManager.toggleModal(document.getElementById('generic-modal'), false);
                            } catch (error) {
                                UIManager.showCustomModal('Error de GPS', 'No se pudo obtener la ubicación. Verifique los permisos y la señal.', [{ text: 'Cerrar', classes: 'bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition' }]);
                            }
                        }
                    });

                    if (plotData) {
                        plotCard.querySelector('.plot-species').value = plotData.species;
                        plotCard.querySelector('.plot-size').value = plotData.size;
                        plotCard.querySelector('.plot-volume-type').value = plotData.volumeType;
                        plotCard.querySelector('.plot-unit').value = plotData.unit;
                        const methodEl = plotCard.querySelector('.plot-method');
                        if(methodEl) methodEl.value = plotData.method;
                        if (plotData.coords) {
                            plotCard.dataset.coords = plotData.coords;
                            const coordsDisplay = plotCard.querySelector('.coords-display');
                            const [lat, lon] = plotData.coords.split(',');
                            coordsDisplay.textContent = `Lat: ${parseFloat(lat).toFixed(5)}, Lon: ${parseFloat(lon).toFixed(5)}`;
                            coordsDisplay.classList.remove('hidden');
                        }
                        
                        treeContainer.innerHTML = '';
                        if (plotData.trees && plotData.trees.length > 0) {
                            plotData.trees.forEach(treeData => {
                                this.createTreeEntry(treeContainer);
                                const newTree = treeContainer.querySelector('div:last-child');
                                newTree.querySelector('.tree-dap').value = treeData.dap;
                                newTree.querySelector('.tree-height').value = treeData.height;
                            });
                        } else {
                             this.createTreeEntry(treeContainer);
                        }
                    } else {
                         this.createTreeEntry(treeContainer);
                    }
                    this.updatePlotCardsUI();
                },

                resetRumaCalculator() {
                    document.getElementById('ruma_largo').value = '';
                    document.getElementById('ruma_heights_container').innerHTML = '';
                    this.createRumaHeightEntry();
                    document.getElementById('ruma_pino_logs_container').innerHTML = '';
                    this.createRumaLogEntry();
                    rumaSaleVolumeInput.value = '';
                    rumaSaleUnitPriceInput.value = '';
                    document.getElementById('ruma_sale_client').value = '';
                    CalculationEngine.updateSaleIncomeDisplay();
                    resultContainer.classList.add('hidden');
                    AppState.lastRumaCalculation = null;
                },

                updatePlotSummary() {
                    const totalAreaHa = parseFloat(document.getElementById('totalAreaHa').value) || 0;
                    let volPerHa = 0;
                    let unit = '';
                    
                    if (AppState.calculatedVolumes.pino > 0) {
                        volPerHa = AppState.calculatedVolumes.pino;
                        unit = 'm³';
                    } else if (AppState.calculatedVolumes.eucaliptoRuma > 0) {
                        volPerHa = AppState.calculatedVolumes.eucaliptoRuma;
                        unit = 'mr';
                    }

                    if (volPerHa > 0) {
                        const totalVolume = volPerHa * totalAreaHa;
                        const totalValue = valueResult.textContent;
                        projectTitlePlot.textContent = (AppState.activeProject && AppState.activeProject.data.type === 'bosque')
                            ? `Proyecto: ${AppState.activeProject.name}`
                            : 'Resumen de Medición Actual';

                        plotTotalVolume.innerHTML = `<div>${totalVolume.toFixed(2)} ${unit} (Total)</div>
                                                   <div class="opacity-70 text-lg mt-1">${totalValue}</div>`;
                        plotProjectSummary.classList.remove('hidden');
                    } else {
                        plotProjectSummary.classList.add('hidden');
                    }
                },

                updateRumaSummary() {
                    if (!AppState.activeProject || AppState.activeProject.data.type !== 'ruma') {
                        rumaProjectSummary.classList.add('hidden');
                        return;
                    }
                    
                    rumaProjectSummary.classList.remove('hidden');
                    projectTitleRuma.textContent = `Resumen: ${AppState.activeProject.name}`;
                    const unit = AppState.activeProject.data.species === 'pino' ? 'm³' : 'mr';
                    
                    let totalProduced = 0, totalFaceVolume350 = 0, totalSold = 0, totalRevenue = 0, totalEstimatedValue = 0;

                    AppState.currentRumaEntries.forEach(entry => {
                        if (entry.type === 'entry') {
                            totalProduced += entry.vol;
                            if(entry.faceVolume) totalFaceVolume350 += entry.faceVolume;
                            totalEstimatedValue += parseFloat((entry.value || '0').replace(/[$.]/g, '')) || 0;
                        } else if (entry.type === 'sale') {
                            const saleVol = parseFloat(entry.vol);
                            const salePrice = parseFloat(entry.salePrice);
                            if (!isNaN(saleVol)) totalSold += Math.abs(saleVol);
                            if (!isNaN(salePrice)) totalRevenue += salePrice;
                        }
                    });

                    const currentStock = totalProduced - totalSold;
                    let faceVolumeHTML = (totalFaceVolume350 > 0)
                        ? `<div class="col-span-2 border-t border-white/10 pt-4 mt-4"><p class="text-sm opacity-70">Volumen Aparente (a 3.50m)</p><p class="font-bold text-md text-slate-300">${totalFaceVolume350.toFixed(3)} mr</p></div>`
                        : '';

                    rumaTotalVolumeContainer.innerHTML = `
                        <div><p class="text-sm opacity-70">Producción Total (Est. 2.44m)</p><p class="font-bold text-lg text-green-400">${totalProduced.toFixed(3)} ${unit}</p></div>
                        <div><p class="text-sm opacity-70">Valor Prod. Estimado</p><p class="font-bold text-lg text-white">${totalEstimatedValue.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' })}</p></div>
                        <div><p class="text-sm opacity-70">Total Vendido</p><p class="font-bold text-lg text-red-400">${totalSold.toFixed(3)} ${unit}</p></div>
                         <div><p class="text-sm opacity-70">Ingresos por Ventas</p><p class="font-bold text-lg text-lime-300">${totalRevenue.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' })}</p></div>
                        <div class="col-span-2"><p class="text-sm opacity-70">Stock Actual (Est. 2.44m)</p><p class="font-bold text-xl text-white">${currentStock.toFixed(3)} ${unit}</p></div>
                        ${faceVolumeHTML}`;
                    
                    CalculationEngine.calculateValue();
                },

                async startCameraMeasurementFlow() {
                    const distance = await this.showInputModal(
                        'Paso 1: Distancia al Árbol',
                        'Mida la distancia horizontal desde su posición actual hasta la base del árbol e ingrésela abajo.',
                        'Distancia (metros)'
                    );

                    if (distance && !isNaN(parseFloat(distance)) && parseFloat(distance) > 0) {
                        SensorManager.startCameraMeasurement(parseFloat(distance));
                    } else if (distance !== null) { // User entered something invalid
                        this.showCustomModal('Entrada Inválida', 'Por favor, ingrese un número válido y positivo para la distancia.', [{ text: 'Reintentar', classes: 'bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition', onClick: () => this.startCameraMeasurementFlow() }]);
                    }
                },

                updateCameraUI(state) {
                    // state: { step: 'base' | 'top' | 'dap', distance: number }
                    const dapDistanceContainer = document.getElementById('camera-dap-distance-container');
                    const actionButtons = document.getElementById('camera-action-buttons');

                    switch (state.step) {
                        case 'base':
                            cameraStepTitle.textContent = 'Paso 2: Medir Altura (Base)';
                            cameraInstructions.textContent = `Apunte con la mira a la BASE del árbol y presione el botón.`;
                            cameraCaptureBtn.textContent = 'Capturar Base';
                            cameraReticle.classList.remove('hidden');
                            dapLinesContainer.classList.add('hidden');
                            
                            dapDistanceContainer.classList.add('hidden');
                            actionButtons.classList.remove('hidden');
                            cameraCaptureBtn.classList.remove('hidden');
                            cameraCaptureBtn.classList.add('col-span-2');
                            cameraCalculateBtn.classList.add('hidden');
                            break;
                        case 'top':
                            cameraStepTitle.textContent = 'Paso 3: Medir Altura (Copa)';
                            cameraInstructions.textContent = 'Ahora apunte a la COPA (punta más alta) del árbol y presione el botón.';
                            cameraCaptureBtn.textContent = 'Capturar Copa';
                            break;
                        case 'dap_distance':
                            cameraStepTitle.textContent = 'Paso 4: Distancia para DAP';
                            cameraInstructions.textContent = `Acérquese al tronco e ingrese la distancia horizontal (ej: 2m).`;
                            actionButtons.classList.add('hidden');
                            dapDistanceContainer.classList.remove('hidden');
                            document.getElementById('camera-dap-distance-input').focus();
                            break;
                        case 'dap_adjust':
                             cameraStepTitle.textContent = 'Paso 5: Ajustar Líneas';
                             cameraInstructions.textContent = `Arrastre las líneas rojas hasta que coincidan con los bordes del tronco. Presione 'Calcular y Guardar' al finalizar.`;
                             cameraReticle.classList.add('hidden');
                             dapLinesContainer.classList.remove('hidden');
                             dapDistanceContainer.classList.add('hidden');
                             actionButtons.classList.remove('hidden');
                             cameraCaptureBtn.classList.add('hidden');
                             cameraCalculateBtn.classList.remove('hidden');
                             break;
                    }
                },
            };

            // --- MODULE: ProjectManager ---
            const ProjectManager = {
                // --- SUB-SECTION: PROJECT MANAGEMENT (SAVE, LOAD, NEW) ---
                getProjectDataToSave() {
                    const activeTab = document.querySelector('input[name="tabs"]:checked').id;
                    if (activeTab === 'tab-plot') {
                        const plots = Array.from(document.querySelectorAll('#plotList .plot-card')).map(card => ({
                            species: card.querySelector('.plot-species').value,
                            size: card.querySelector('.plot-size').value,
                            volumeType: card.querySelector('.plot-volume-type').value,
                            unit: card.querySelector('.plot-unit').value,
                            method: card.querySelector('.plot-method') ? card.querySelector('.plot-method').value : 'equation',
                            coords: card.dataset.coords || '',
                            trees: Array.from(card.querySelectorAll('.tree-list-container > div')).map(tree => ({
                                dap: tree.querySelector('.tree-dap').value,
                                height: tree.querySelector('.tree-height').value
                            }))
                        }));
                        return { type: 'bosque', totalAreaHa: document.getElementById('totalAreaHa').value, plots, price: priceInput.value };
                    }
                    if (activeTab === 'tab-ruma') {
                         if (AppState.lastRumaCalculation) {
                            AppState.currentRumaEntries.push(AppState.lastRumaCalculation);
                            AppState.lastRumaCalculation = null;
                        }
                        return { type: 'ruma', entries: AppState.currentRumaEntries, price: priceInput.value, species: document.getElementById('ruma_species').value };
                    }
                    return null;
                },

                loadProject(project) {
                    AppState.activeProject = project;
                    const data = project.data;
                    
                    plotList.innerHTML = '';
                    AppState.currentRumaEntries = [];
                    plotProjectSummary.classList.add('hidden');
                    rumaProjectSummary.classList.add('hidden');

                    if (data.type === 'bosque') {
                        document.getElementById('tab-plot').checked = true;
                        plotProjectSummary.classList.remove('hidden');
                        projectTitlePlot.textContent = `Proyecto: ${project.name}`;
                        document.getElementById('totalAreaHa').value = data.totalAreaHa || '';
                        if (data.plots && data.plots.length > 0) {
                            data.plots.forEach(plotData => UIManager.createPlotEntry(plotData));
                        } else {
                            UIManager.createPlotEntry();
                        }
                        UIManager.resetRumaCalculator();
                        priceInput.value = data.price || ''; 
                        AppState.activeProjectPrice = data.price || '';

                    } else if (data.type === 'ruma') {
                        document.getElementById('tab-ruma').checked = true;
                        document.getElementById('ruma_species').value = data.species || 'eucalipto';
                        rumaProjectSummary.classList.remove('hidden');
                        projectTitleRuma.textContent = `Proyecto: ${project.name}`;
                        if (data.entries) AppState.currentRumaEntries = data.entries;
                        priceInput.value = data.price || '';
                        AppState.activeProjectPrice = data.price || '';
                        UIManager.updateRumaSummary();
                        UIManager.createPlotEntry();
                        UIManager.resetRumaCalculator();
                    }
                    AppState.hasUnsavedChanges = false;
                    UIManager.handleTabChange();
                    calculateAndDisplay();
                },

                clearProject() {
                    AppState.activeProject = null;
                    AppState.activeProjectPrice = '';
                    plotProjectSummary.classList.add('hidden');
                    rumaProjectSummary.classList.add('hidden');
                    AppState.currentRumaEntries = [];
                    plotList.innerHTML = '';
                    document.getElementById('ruma_heights_container').innerHTML = '';
                    document.getElementById('ruma_pino_logs_container').innerHTML = '';
                    document.getElementById('totalAreaHa').value = '';
                    document.getElementById('ruma_largo').value = '';
                    priceInput.value = '';
                    valueResultContainer.classList.add('hidden');
                    resultContainer.classList.add('hidden');
                    UIManager.createPlotEntry();
                    UIManager.createRumaHeightEntry();
                    UIManager.createRumaLogEntry();
                    UIManager.updateRumaSummary();
                    AppState.hasUnsavedChanges = false;
                    UIManager.handleTabChange();
                },

                // --- SUB-SECTION: EXPORT LOGIC (PDF, CSV) ---
                async generatePdfReport() {
                    await UIManager.loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
                    if (!AppState.activeProject) {
                         UIManager.showCustomModal('Error', 'No hay un proyecto activo para exportar.', [{ text: 'Entendido', classes: 'bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition' }]);
                        return;
                    }

                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const today = new Date().toLocaleDateString('es-CL');
                    const project = AppState.activeProject;
                    
                    doc.setFontSize(22);
                    doc.setFont('helvetica', 'bold');
                    doc.text("CubiFor - Informe de Proyecto", doc.internal.pageSize.getWidth() / 2, 22, { align: 'center' });
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'normal');
                    doc.text(`Proyecto: ${project.name}`, 14, 40);
                    doc.text(`Fecha: ${today}`, 14, 48);

                    if (project.data.type === 'bosque') {
                        const reportData = AppState.dasometricReportData;
                         doc.autoTable({
                            startY: 60,
                            head: [['Especie', 'Árboles/ha (N)', 'Área Basal/ha (G)', 'DMC (cm)', 'Volumen/ha']],
                            body: Object.entries(reportData.speciesData).map(([species, data]) => [
                                species === 'pino' ? 'Pino' : 'E. Globulus',
                                data.N.toFixed(1),
                                data.G.toFixed(2) + ' m²/ha',
                                data.DMC.toFixed(1),
                                data.Vol.toFixed(2) + ' ' + data.unit + '/ha'
                            ]),
                            theme: 'striped'
                        });
                    } else if (project.data.type === 'ruma') {
                        doc.autoTable({
                            startY: 60,
                            head: [['Fecha', 'Tipo', 'Detalle', 'Volumen', 'Valor/Ingreso']],
                            body: AppState.currentRumaEntries.map(entry => {
                                let valueDisplay = '';
                                if (entry.type === 'entry') valueDisplay = entry.value || '$0';
                                else if (entry.type === 'sale') valueDisplay = entry.salePrice.toLocaleString('es-CL', {style:'currency', currency:'CLP'});

                                return [
                                    entry.date,
                                    entry.type === 'entry' ? 'Entrada' : 'Venta',
                                    entry.details || entry.client,
                                    entry.vol.toFixed(3),
                                    valueDisplay
                                ];
                            }),
                            theme: 'striped'
                        });
                    }
                    doc.save(`Reporte_CubiFor_${project.name.replace(/ /g, '_')}.pdf`);
                },
                
                async generateDelimitationPdfReport() {
                    const propertyName = await UIManager.showInputModal('Nombre del Predio', 'Ingrese un nombre para el predio del informe.', AppState.activeProject ? AppState.activeProject.name : 'Mi Predio');
                    if (!propertyName) return; 

                    await UIManager.loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js');
                    await UIManager.loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');

                    UIManager.showCustomModal('Generando PDF...', 'Por favor espere, estamos capturando el mapa.', []);

                    const mapElement = document.getElementById('map');
                    // Temporarily remove controls for a cleaner screenshot
                    const controls = mapElement.querySelectorAll('.leaflet-control-container');
                    controls.forEach(c => c.style.display = 'none');
                    
                    const mapCanvas = await html2canvas(mapElement);
                    const compassCanvas = await html2canvas(document.querySelector('#compass-rose').parentElement);
                    
                    // Restore controls
                    controls.forEach(c => c.style.display = 'block');

                    const mapImgData = mapCanvas.toDataURL('image/png');
                    const compassImgData = compassCanvas.toDataURL('image/png');

                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('p', 'mm', 'a4');
                    const today = new Date().toLocaleDateString('es-CL');
                    const pageHeight = doc.internal.pageSize.getHeight();
                    const pageWidth = doc.internal.pageSize.getWidth();

                    doc.setFontSize(22);
                    doc.setFont('helvetica', 'bold');
                    doc.text("CubiFor", pageWidth / 2, 20, { align: 'center' });
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'normal');
                    doc.text("Informe de Delimitación de Predio", pageWidth / 2, 30, { align: 'center' });
                    doc.setFontSize(14);
                    doc.setTextColor(100);
                    doc.text(`Predio: ${propertyName}`, pageWidth / 2, 40, { align: 'center' });

                    const mapAspectRatio = mapCanvas.width / mapCanvas.height;
                    const imgWidth = 180;
                    const imgHeight = imgWidth / mapAspectRatio;
                    doc.addImage(mapImgData, 'PNG', 15, 50, imgWidth, imgHeight);

                    let currentY = 50 + imgHeight + 10;
                    if (currentY > pageHeight - 60) { // Check if content fits
                        doc.addPage();
                        currentY = 20;
                    }

                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text("Resultados de la Delimitación", 15, currentY);
                    currentY += 7;
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(11);
                    doc.text(`Área: ${calculatedArea.textContent}`, 20, currentY);
                    doc.text(`Perímetro: ${calculatedPerimeter.textContent}`, 100, currentY);
                    currentY += 10;

                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text("Ubicación y Orientación", 15, currentY);
                    currentY += 2;
                    
                    const compassSize = 35;
                    doc.addImage(compassImgData, 'PNG', 20, currentY, compassSize, compassSize);
                    
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(10);
                    const lat = document.getElementById('latitude').textContent;
                    const lon = document.getElementById('longitude').textContent;
                    const acc = document.getElementById('accuracy').textContent;
                    const azi = document.getElementById('azimuth').textContent;
                    doc.text(`Coordenadas de Referencia (WGS84):`, 70, currentY + 5);
                    doc.setFont('courier', 'normal');
                    doc.text(`Latitud: ${lat}`, 72, currentY + 11);
                    doc.text(`Longitud: ${lon}`, 72, currentY + 16);
                    doc.text(`Precisión: ${acc}`, 72, currentY + 21);
                    doc.setFont('helvetica', 'normal');
                    doc.text(`Azimut Actual: ${azi}`, 72, currentY + 26);
                    
                    doc.setFontSize(9);
                    doc.setTextColor(150);
                    doc.text(`Informe generado por CubiFor el ${today}`, pageWidth / 2, pageHeight - 10, { align: 'center' });

                    UIManager.toggleModal(document.getElementById('generic-modal'), false);
                    doc.save(`Informe_Delimitacion_${propertyName.replace(/ /g, '_')}.pdf`);
                }
            };

            // --- MODULE: SensorManager ---
            const SensorManager = {
                // --- SUB-SECTION: NAVIGATION (GPS & COMPASS) ---
                initializeMap(initialPosition, popupMessage = 'Tu ubicación') {
                    if (AppState.map) {
                        AppState.map.setView([initialPosition.coords.latitude, initialPosition.coords.longitude], 16);
                        return;
                    }
                    const { latitude, longitude, accuracy } = initialPosition.coords;
                    AppState.map = L.map('map').setView([latitude, longitude], 16);
                    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                        attribution: 'Tiles &copy; Esri'
                    }).addTo(AppState.map);

                    AppState.userMarker = L.marker([latitude, longitude]).addTo(AppState.map)
                        .bindPopup(popupMessage)
                        .openPopup();
                        
                    AppState.accuracyCircle = L.circle([latitude, longitude], {
                        radius: accuracy, color: '#1d4ed8', fillColor: '#3b82f6',
                        fillOpacity: 0.15, weight: 2
                    }).addTo(AppState.map);
                    
                    this.initializeDrawingTools();

                    requestAnimationFrame(() => {
                        AppState.map.invalidateSize(true);
                    });
                },

                initializeDrawingTools() {
                    const drawnItems = new L.FeatureGroup().addTo(AppState.map);
                    AppState.drawControl = new L.Control.Draw({
                        edit: { featureGroup: drawnItems },
                        draw: {
                            polygon: { shapeOptions: { color: '#a3e635' } },
                            polyline: false, rectangle: false, circle: false, marker: false, circlemarker: false
                        }
                    });
                    
                    // We add the control but hide it, we will trigger it with our custom buttons.
                    AppState.map.addControl(AppState.drawControl);
                    document.querySelector('.leaflet-draw').style.display = 'none';

                    AppState.map.on(L.Draw.Event.CREATED, (e) => {
                        if (AppState.drawnLayer) {
                            drawnItems.removeLayer(AppState.drawnLayer);
                        }
                        const layer = e.layer;
                        AppState.drawnLayer = layer;
                        drawnItems.addLayer(layer);
                        this.calculateAndDisplayGeometry(layer);
                        undoDrawBtn.disabled = true;
                    });
                     AppState.map.on(L.Draw.Event.DRAWSTART, (e) => {
                        if (AppState.drawnLayer) {
                             drawnItems.removeLayer(AppState.drawnLayer);
                             AppState.drawnLayer = null;
                        }
                        drawingResultsContainer.classList.add('hidden');
                        AppState.polygonDrawer = e.layer;
                        undoDrawBtn.disabled = false;
                    });
                },

                calculateAndDisplayGeometry(layer) {
                    try {
                        const geojson = layer.toGeoJSON();
                        const areaM2 = turf.area(geojson);
                        const areaHa = areaM2 / 10000;

                        let perimeter = 0;
                        const latlngs = layer.getLatLngs()[0];
                        for (let i = 0; i < latlngs.length - 1; i++) {
                            perimeter += AppState.map.distance(latlngs[i], latlngs[i + 1]);
                        }
                        perimeter += AppState.map.distance(latlngs[latlngs.length - 1], latlngs[0]);
                        
                        calculatedArea.textContent = `${areaHa.toFixed(4)} ha`;
                        calculatedArea.dataset.hectares = areaHa.toFixed(4);
                        calculatedPerimeter.textContent = `${perimeter.toFixed(2)} m`;
                        drawingResultsContainer.classList.remove('hidden');
                    } catch(error) {
                        console.error("Error calculating geometry:", error);
                        UIManager.showCustomModal('Error de Cálculo', 'No se pudo calcular el área o perímetro del polígono.', [{ text: 'OK', classes: 'bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition' }]);
                    }
                },

                getSmoothedHeading(newHeading) {
                    AppState.compassHistory.push(newHeading);
                    if (AppState.compassHistory.length > COMPASS_SMOOTHING_SAMPLES) {
                        AppState.compassHistory.shift();
                    }

                    let sumX = 0;
                    let sumY = 0;
                    for (const angle of AppState.compassHistory) {
                        const rad = angle * (Math.PI / 180);
                        sumX += Math.cos(rad);
                        sumY += Math.sin(rad);
                    }

                    const avgX = sumX / AppState.compassHistory.length;
                    const avgY = sumY / AppState.compassHistory.length;
                    const accuracy = position.coords;
                    latitudeDisplay.textContent = latitude.toFixed(6);
                    longitudeDisplay.textContent = longitude.toFixed(6);
                    accuracyDisplay.textContent = `± ${accuracy.toFixed(1)} m`;

                    if (typeof geomag !== 'undefined') {
                        AppState.magneticDeclination = geomag.field(latitude, longitude).decl;
                    }

                    if (AppState.map && AppState.userMarker && AppState.accuracyCircle) {
                        const latLng = [latitude, longitude];
                        AppState.userMarker.setLatLng(latLng);
                        AppState.accuracyCircle.setLatLng(latLng);
                        AppState.accuracyCircle.setRadius(accuracy);
                    }
                },

                handlePositionError(error) {
                    let message = '<b>Error de GPS:</b> ' + (
                        error.code === 1 ? 'Permiso de ubicación denegado.' :
                        error.code === 2 ? 'Ubicación no disponible en este momento.' :
                        error.code === 3 ? 'Tiempo de espera agotado al solicitar la ubicación.' :
                        'No se pudo obtener la ubicación.'
                    );
                    sensorsError.innerHTML = `<p>${message}</p>`;
                },

                requestOrientationPermission() {
                    return new Promise(async (resolve, reject) => {
                        if (typeof window.DeviceOrientationEvent.requestPermission === 'function') {
                            try {
                                const permissionState = await window.DeviceOrientationEvent.requestPermission();
                                if (permissionState === 'granted') {
                                    resolve();
                                } else {
                                    reject(new Error('Permiso de orientación denegado.'));
                                }
                            } catch (error) {
                                reject(error);
                            }
                        } else {
                            // Non-iOS devices don't need to ask, so we can just resolve.
                            resolve();
                        }
                    });
                },

                async activateSensorsAndMap() {
                    sensorsError.innerHTML = '';
                    
                    try {
                        // STEP 1: Request permissions immediately.
                        const [position, _] = await Promise.all([
                            this.requestGpsPermission(),
                            this.requestOrientationPermission()
                        ]);
                        
                        // If permissions are granted, show the content area.
                        sensorsContent.classList.remove('hidden');
                        activateSensorsContainer.classList.add('hidden');

                        // STEP 2: Load scripts AFTER permissions are granted.
                        await Promise.all([
                            UIManager.loadScript('https://unpkg.com/leaflet@1.9.4/dist/leaflet.js'),
                            UIManager.loadScript('https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js'),
                            UIManager.loadScript('https://npmcdn.com/@turf/turf/turf.min.js'),
                            UIManager.loadScript('https://cdn.jsdelivr.net/npm/geomag@0.3.1/geomag.min.js')
                        ]);
                        
                        // STEP 3: Initialize map and sensors.
                        document.getElementById('map').classList.remove('hidden');
                        drawingToolsContainer.classList.remove('hidden');
                        this.initializeMap(position);
                        
                        // Set initial position & start watching for changes
                        this.handlePosition(position);
                        AppState.gpsWatchId = navigator.geolocation.watchPosition(this.handlePosition.bind(this), this.handlePositionError.bind(this), { enableHighAccuracy: true });
                        
                        // Start listening for orientation changes
                        if ('DeviceOrientationEvent' in window) {
                            window.addEventListener('deviceorientation', this.handleOrientation.bind(this));
                            azimuthDisplay.textContent = '...';
                            directionDisplay.textContent = 'Calibrando...';
                        } else {
                            azimuthDisplay.textContent = "N/A";
                            directionDisplay.textContent = "No soportado";
                        }

                    } catch (err) {
                        // This will catch both permission denials and script loading errors.
                        console.error("Sensor activation failed:", err);
                        sensorsContent.classList.remove('hidden');
                        activateSensorsContainer.classList.add('hidden');
                        
                        let message = '';
                        if (err && err.message.toLowerCase().includes('denied')) {
                             message = '<b>Permisos denegados.</b> Revisa los ajustes de privacidad de tu navegador/dispositivo para permitir el acceso a la ubicación y al movimiento.';
                        } else if (err && err.message.includes('orientación denegado')) {
                            message = '<b>Permiso de movimiento denegado.</b> En iOS, puedes activarlo en Ajustes > Safari > Movimiento y Orientación.';
                        }
                        else {
                            message = 'No se pudieron activar los sensores. Por favor, asegúrate de tener buena señal y de haber otorgado los permisos necesarios.';
                        }
                        sensorsError.innerHTML = `<p>${message}</p>`;
                    }
                },

                async startCameraMeasurement(distance) {
                    if (typeof window.DeviceOrientationEvent.requestPermission === 'function') {
                        const permissionState = await window.DeviceOrientationEvent.requestPermission();
                        if (permissionState !== 'granted') {
                            UIManager.showCustomModal('Permiso Requerido', 'Se necesita acceso a los sensores de movimiento para medir los ángulos.', [{ text: 'Entendido', classes: 'bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition' }]);
                            return;
                        }
                    }

                    document.body.classList.add('camera-active');
                    const measurementState = {
                        distanceToBase: distance,
                        currentPitch: 0,
                        angleBase: null,
                        angleTop: null,
                        distanceForDap: null,
                        dapLineLeftPos: -50,
                        dapLineRightPos: 50,
                        step: 'base',
                    };

                    const handleDevicePitch = (event) => {
                        if (event.beta !== null) {
                            measurementState.currentPitch = 90 - event.beta;
                            liveAngleDisplay.textContent = `${measurementState.currentPitch.toFixed(1)}°`;
                        }
                    };
                    window.addEventListener('deviceorientation', handleDevicePitch);
                    
                    let isDragging = null, startX = 0, initialTranslateX = 0;
                    const dapLineLeft = document.getElementById('dap-line-left');
                    const dapLineRight = document.getElementById('dap-line-right');
                    
                    function dragStart(e, line) {
                        isDragging = line;
                        const lineEl = (line === 'left') ? dapLineLeft : dapLineRight;
                        startX = (e.type === 'touchstart') ? e.touches[0].clientX : e.clientX;
                        const transform = window.getComputedStyle(lineEl).transform;
                        initialTranslateX = (transform && transform !== 'none') ? new DOMMatrixReadOnly(transform).m41 : (line === 'left' ? -50 : 50);
                        if(e.type === 'mousedown') e.preventDefault();
                        document.addEventListener('mousemove', dragMove);
                        document.addEventListener('mouseup', dragEnd);
                        document.addEventListener('touchmove', dragMove, { passive: false });
                        document.addEventListener('touchend', dragEnd);
                    }

                    function dragMove(e) {
                        if (!isDragging) return;
                        e.preventDefault();
                        const currentX = (e.type === 'touchmove') ? e.touches[0].clientX : e.clientX;
                        const dx = currentX - startX;
                        const newTranslateX = initialTranslateX + dx;
                        const lineEl = (isDragging === 'left') ? dapLineLeft : dapLineRight;
                        lineEl.style.transform = `translateX(${newTranslateX}px)`;
                        measurementState[isDragging === 'left' ? 'dapLineLeftPos' : 'dapLineRightPos'] = newTranslateX;
                    }

                    function dragEnd() {
                        isDragging = null;
                        document.removeEventListener('mousemove', dragMove);
                        document.removeEventListener('mouseup', dragEnd);
                        document.removeEventListener('touchmove', dragMove);
                        document.removeEventListener('touchend', dragEnd);
                    }

                    const dragStartLeft = (e) => dragStart(e, 'left');
                    const dragStartRight = (e) => dragStart(e, 'right');

                    const activateDapDragging = () => {
                        dapLineLeft.addEventListener('mousedown', dragStartLeft);
                        dapLineRight.addEventListener('mousedown', dragStartRight);
                        dapLineLeft.addEventListener('touchstart', dragStartLeft, { passive: false });
                        dapLineRight.addEventListener('touchstart', dragStartRight, { passive: false });
                    };
                    
                    const deactivateDapDragging = () => {
                        dapLineLeft.removeEventListener('mousedown', dragStartLeft);
                        dapLineRight.removeEventListener('mousedown', dragStartRight);
                        dapLineLeft.removeEventListener('touchstart', dragStartLeft);
                        dapLineRight.removeEventListener('touchstart', dragStartRight);
                    };

                    const stopMeasurement = () => {
                        document.body.classList.remove('camera-active');
                        if (cameraFeed.srcObject) {
                            cameraFeed.srcObject.getTracks().forEach(track => track.stop());
                            cameraFeed.srcObject = null;
                        }
                        window.removeEventListener('deviceorientation', handleDevicePitch);
                        deactivateDapDragging();
                        UIManager.toggleModal(cameraMeasurementModal, false);
                        cameraCaptureBtn.onclick = null;
                        document.getElementById('camera-dap-continue-btn').onclick = null;
                        cameraCalculateBtn.onclick = null;
                        cameraCancelBtn.onclick = null;
                    };

                    const advanceStep = () => {
                        switch (measurementState.step) {
                            case 'base':
                                measurementState.angleBase = measurementState.currentPitch;
                                UIManager.showCustomModal('Ángulo Capturado', `Ángulo de la base: ${measurementState.angleBase.toFixed(1)}°`, [{ text: 'Continuar', classes: 'bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition' }]);
                                measurementState.step = 'top';
                                UIManager.updateCameraUI(measurementState);
                                break;
                            case 'top':
                                 measurementState.angleTop = measurementState.currentPitch;
                                 UIManager.showCustomModal('Ángulo Capturado', `Ángulo de la copa: ${measurementState.angleTop.toFixed(1)}°`, [{ text: 'Continuar', classes: 'bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition' }]);
                                measurementState.step = 'dap_distance';
                                UIManager.updateCameraUI(measurementState);
                                break;
                        }
                    };
                    
                    cameraCaptureBtn.onclick = advanceStep;

                    document.getElementById('camera-dap-continue-btn').onclick = () => {
                        const distInput = document.getElementById('camera-dap-distance-input');
                        const dist = distInput.value;
                        if (dist && !isNaN(parseFloat(dist)) && parseFloat(dist) > 0) {
                            measurementState.distanceForDap = parseFloat(dist);
                            measurementState.step = 'dap_adjust';
                            UIManager.updateCameraUI(measurementState);
                            activateDapDragging();
                        } else {
                            UIManager.showCustomModal('Entrada Inválida', 'Por favor, ingrese un número válido y positivo.', [{ text: 'OK', classes: 'bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition' }]);
                            distInput.focus();
                        }
                    };

                    cameraCalculateBtn.onclick = () => {
                        let calculatedHeight = null;
                        if (measurementState.angleBase !== null && measurementState.angleTop !== null) {
                            const angleBaseRad = measurementState.angleBase * (Math.PI / 180);
                            const angleTopRad = measurementState.angleTop * (Math.PI / 180);
                            calculatedHeight = measurementState.distanceToBase * (Math.tan(angleTopRad) - Math.tan(angleBaseRad));
                        }

                        let finalDap = null;
                        if (measurementState.distanceForDap) {
                            const pixelSeparation = measurementState.dapLineRightPos - measurementState.dapLineLeftPos;
                            const screenWidth = cameraFeed.offsetWidth;
                            const fovRad = ASSUMED_CAMERA_FOV * (Math.PI / 180);
                            const angleSubtended = (pixelSeparation / screenWidth) * fovRad;
                            const calculatedDapMeters = 2 * measurementState.distanceForDap * Math.tan(angleSubtended / 2);
                            finalDap = calculatedDapMeters * 100;
                        }

                        let heightMessage = 'No se pudo calcular la altura.';
                        if (calculatedHeight !== null && !isNaN(calculatedHeight) && calculatedHeight > 0) {
                            heightInput.value = calculatedHeight.toFixed(2);
                            heightMessage = `Altura calculada: <b>${calculatedHeight.toFixed(2)}m</b>.`;
                        } else if (measurementState.angleBase !== null && measurementState.angleTop !== null) {
                             heightMessage = `No se pudo calcular la altura (el ángulo de la copa [${measurementState.angleTop.toFixed(1)}°] debe ser mayor que el de la base [${measurementState.angleBase.toFixed(1)}°]).`;
                        }
                        
                        let dapMessage = 'No se midió el DAP.';
                        if (finalDap !== null && !isNaN(finalDap) && finalDap > 0) {
                            dapInput.value = finalDap.toFixed(1);
                            dapMessage = `DAP estimado: <b>${finalDap.toFixed(1)}cm</b>.`;
                        } else if (measurementState.distanceForDap) {
                            dapMessage = 'No se pudo estimar el DAP.';
                        }
                        
                        UIManager.showCustomModal('Medición Completa', `${heightMessage}<br>${dapMessage}`, [{ text: 'Aceptar', classes: 'bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition' }]);
                        calculateAndDisplay();
                        stopMeasurement();
                    };
                    cameraCancelBtn.onclick = stopMeasurement;

                    try {
                        await this.startCameraStream();
                        UIManager.toggleModal(cameraMeasurementModal, true);
                        UIManager.updateCameraUI(measurementState);
                    } catch (err) {
                        console.error("Failed to start camera:", err);
                        UIManager.showCustomModal('Error de Cámara', 'No se pudo acceder a la cámara. Verifique los permisos en su navegador y que no esté siendo usada por otra aplicación.', [{ text: 'Cerrar', classes: 'bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition' }]);
                        document.body.classList.remove('camera-active');
                    }
                },

                async startCameraStream() {
                    if (cameraFeed.srcObject) return;
                    const constraints = { video: { facingMode: 'environment' } };
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia(constraints);
                        cameraFeed.srcObject = stream;
                    } catch (err) {
                        console.error("getUserMedia error:", err);
                        throw err;
                    }
                },

                requestGpsPermission() {
                     return new Promise((resolve, reject) => {
                        if (!("geolocation" in navigator)) {
                            return reject(new Error("GPS no soportado."));
                        }
                        navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 });
                    });
                },

                stopNavigationSensors() {
                    window.removeEventListener('deviceorientation', this.handleOrientation);
                    if (AppState.gpsWatchId !== null) {
                        navigator.geolocation.clearWatch(AppState.gpsWatchId);
                        AppState.gpsWatchId = null;
                    }
                },

                degToCardinal(deg) {
                    const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSO', 'SO', 'OSO', 'O', 'ONO', 'NO', 'NNO'];
                    const index = Math.round((deg % 360) / 22.5) % 16;
                    return directions[index];
                }
            };

            // --- CENTRAL ORCHESTRATION ---
            function calculateAndDisplay() {
                AppState.calculatedVolumes = { pino: 0, eucaliptoSolid: 0, eucaliptoRuma: 0 };
                AppState.lastRumaCalculation = null;
                const activeTab = document.querySelector('input[name="tabs"]:checked').id;
                addRumaToProjectBtn.classList.add('hidden');
                let isValid = false;

                switch(activeTab) {
                    case 'tab-standing':
                        isValid = CalculationEngine.calculateStandingTreeVolume();
                        break;
                    case 'tab-plot':
                        isValid = CalculationEngine.calculatePlotVolume();
                        break;
                    case 'tab-ruma':
                        isValid = CalculationEngine.processRumaMovement();
                        break;
                }

                if (isValid) {
                    if (activeTab === 'tab-ruma' && AppState.activeProject) {
                         addRumaToProjectBtn.classList.remove('hidden');
                    }
                    resultContainer.classList.remove('hidden');
                    document.getElementById('result').classList.remove('hidden');
                    CalculationEngine.calculateValue();
                } else {
                     if (AppState.activeProject && AppState.activeProject.data.type === 'ruma') {
                        resultContainer.classList.remove('hidden');
                        resultTitle.textContent = 'Resumen del Proyecto';
                        resultValue.innerHTML = "Actualizado en el panel superior.";
                    } else {
                        resultContainer.classList.add('hidden');
                    }
                }
            }
            
            function bindEventListeners() {
                document.querySelectorAll('input[name="tabs"]').forEach(radio => radio.addEventListener('change', UIManager.handleTabChange));
                themeToggle.addEventListener('click', () => {
                    appContainer.classList.toggle('high-contrast');
                    const isHighContrast = appContainer.classList.contains('high-contrast');
                    themeIconSun.classList.toggle('hidden', isHighContrast);
                    themeIconMoon.classList.toggle('hidden', !isHighContrast);
                    localStorage.setItem('cubiforTheme', isHighContrast ? 'high' : 'dark');
                });
                
                // Project Manager Events
                newProjectBtn.addEventListener('click', () => {
                     if (AppState.hasUnsavedChanges) {
                        UIManager.showCustomModal('Cambios sin Guardar', '¿Deseas guardar los cambios antes de crear un proyecto nuevo?', [
                            { text: 'Guardar y Continuar', classes: 'bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition', onClick: () => saveProjectBtn.click() },
                            { text: 'Continuar sin Guardar', classes: 'bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition', onClick: () => ProjectManager.clearProject() },
                            { text: 'Cancelar', classes: 'bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg transition' }
                        ]);
                    } else {
                        ProjectManager.clearProject();
                    }
                });
                saveProjectBtn.addEventListener('click', () => {
                    document.getElementById('project-name-input').value = AppState.activeProject ? AppState.activeProject.name : '';
                    UIManager.toggleModal(saveModal, true)
                });
                loadProjectBtn.addEventListener('click', () => UIManager.toggleModal(loadModal, true));
                
                exportPdfBtn.addEventListener('click', () => {
                    if (AppState.activeProject) {
                        ProjectManager.generatePdfReport();
                    } else {
                         UIManager.showCustomModal('Error de Exportación', 'No hay un proyecto activo para generar un informe.', [{ text: 'Entendido', classes: 'bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition' }]);
                    }
                });
                
                exportMapPdfBtn.addEventListener('click', () => {
                    if(AppState.drawnLayer) {
                        ProjectManager.generateDelimitationPdfReport();
                    } else {
                        UIManager.showCustomModal('Acción Requerida', 'Primero debe dibujar un polígono en el mapa para poder exportar el informe.', [{ text: 'OK', classes: 'bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition' }]);
                    }
                });

                // Calculation & Input Events
                appContainer.addEventListener('input', (e) => {
                    if (e.target.matches('input, select')) {
                        AppState.hasUnsavedChanges = true;
                        calculateAndDisplay();
                    }
                });
                appContainer.addEventListener('change', (e) => {
                    if (e.target.matches('select')) {
                        AppState.hasUnsavedChanges = true;
                        calculateAndDisplay();
                    }
                });

                // Other UI events
                document.getElementById('addPlotBtn').addEventListener('click', () => UIManager.createPlotEntry());
                addRumaToProjectBtn.addEventListener('click', () => {
                    if (AppState.lastRumaCalculation) {
                        AppState.currentRumaEntries.push(AppState.lastRumaCalculation);
                        AppState.hasUnsavedChanges = true;
                        UIManager.updateRumaSummary();
                        UIManager.resetRumaCalculator();
                    }
                });
                measureTreeBtn.addEventListener('click', () => {
                    UIManager.startCameraMeasurementFlow();
                });
                document.getElementById('measurement-help-btn').addEventListener('click', () => {
                    UIManager.toggleModal(measurementHelpModal, true);
                });
                document.getElementById('measurement-help-close').addEventListener('click', () => {
                     UIManager.toggleModal(measurementHelpModal, false);
                });

                activateSensorsBtn.addEventListener('click', () => SensorManager.activateSensorsAndMap());
                mapExpandBtn.addEventListener('click', () => {
                    mapContainer.classList.add('fullscreen');
                    document.body.classList.add('map-fullscreen-active');
                    mapExpandBtn.classList.add('hidden');
                    mapCloseBtn.classList.remove('hidden');
                    if (AppState.map) setTimeout(() => AppState.map.invalidateSize(), 100);
                });
                mapCloseBtn.addEventListener('click', () => {
                    mapContainer.classList.remove('fullscreen');
                    document.body.classList.remove('map-fullscreen-active');
                    mapExpandBtn.classList.remove('hidden');
                    mapCloseBtn.classList.add('hidden');
                    if (AppState.map) setTimeout(() => AppState.map.invalidateSize(), 100);
                });
                
                // Drawing tools event listeners
                startDrawBtn.addEventListener('click', () => {
                    AppState.polygonDrawer = new L.Draw.Polygon(AppState.map, AppState.drawControl.options.draw.polygon);
                    AppState.polygonDrawer.enable();
                });
                undoDrawBtn.addEventListener('click', () => {
                    if (AppState.polygonDrawer) {
                        AppState.polygonDrawer.deleteLastVertex();
                    }
                });
                searchRolBtn.addEventListener('click', () => {
                    const rol = document.getElementById('rol-input').value;
                    if (!rol) {
                         UIManager.showCustomModal('Entrada Requerida', 'Por favor, ingrese un ROL para buscar.', [{ text: 'OK', classes: 'bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition' }]);
                        return;
                    }
                     UIManager.showCustomModal('Función no Disponible', 'La búsqueda automática por ROL es una funcionalidad futura. Por ahora, por favor use el dibujo manual.', [{ text: 'Entendido', classes: 'bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition' }]);
                });
                useAreaBtn.addEventListener('click', () => {
                    const area = calculatedArea.dataset.hectares;
                    if(area && area > 0) {
                        document.getElementById('tab-plot').checked = true;
                        UIManager.handleTabChange();
                        document.getElementById('totalAreaHa').value = area;
                        calculateAndDisplay();
                         UIManager.showCustomModal('Área Transferida', `El área de ${area} ha ha sido copiada al campo de superficie en la pestaña "Bosque".`, [{ text: 'Excelente', classes: 'bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition' }]);
                    }
                });
            }

            function init() {
                ProjectManager.clearProject();
                UIManager.applyInitialTheme();
                const unit = document.getElementById('ruma_species').value === 'pino' ? 'm³' : 'mr';
                document.getElementById('ruma_sale_unit').textContent = unit;
                document.getElementById('ruma_sale_unit_label').textContent = unit;
                bindEventListeners();
            }
            
            document.addEventListener('DOMContentLoaded', init);
        })();
        /* --- END: JAVASCRIPT LOGIC SECTION --- */
    </script>
</body>
</html>

